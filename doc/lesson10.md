<article class="markdown-body entry-content container-lg" itemprop="text"><h1><a id="user-content-онлайн-проекта-topjava" class="anchor" aria-hidden="true" href="#онлайн-проекта-topjava"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Онлайн-проекта <a href="https://github.com/JavaWebinar/topjava">TopJava</a></h1>
<h2><a id="user-content-материалы-занятия" class="anchor" aria-hidden="true" href="#материалы-занятия"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFfk43cG91Yk9pM3JxUHVhNFVVdHlxSlJtZm5oY3A4YXRtNk1KWEZxRlFNeW8" rel="nofollow">Материалы занятия</a></h2>
<h3><a id="user-content--правки-в-проекте" class="anchor" aria-hidden="true" href="#-правки-в-проекте"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png" alt="correction" style="max-width:100%;"></a> Правки в проекте</h3>
<h4><a id="user-content-apply-10_0_fixpatch" class="anchor" aria-hidden="true" href="#apply-10_0_fixpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_0_fix.patch</h4>
<blockquote>
<p>Небольшие исправления</p>
</blockquote>
<h2><a id="user-content--разбор-домашнего-задания-hw9" class="anchor" aria-hidden="true" href="#-разбор-домашнего-задания-hw9"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png" alt="hw" style="max-width:100%;"></a> Разбор домашнего задания HW9</h2>
<h3><a id="user-content--1-hw9" class="anchor" aria-hidden="true" href="#-1-hw9"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 1. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFZnQ2dDZsT0dvYjQ" rel="nofollow">HW9</a></h3>
<h4><a id="user-content-apply-10_01_hw9_binding_ajaxpatch" class="anchor" aria-hidden="true" href="#apply-10_01_hw9_binding_ajaxpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_01_HW9_binding_ajax.patch</h4>
<p>Datatables перевели на ajax (<code>"ajax": {"url": ajaxUrl, ..</code>), те при отрисовке таблица сама по этому url запрашивает данные. Поэтому в методе <code>RootController.meals()</code> нам нужно только возвратить view "meals" (<code>meals.jsp</code>) которому уже не нужны данные в атрибутах.</p>
<blockquote>
<ul>
<li>JavaScript <code>i18n[]</code> локализацию перенес в <code>i18n.jsp</code> и передаю туда <code>page</code> как параметр
<ul>
<li><a href="https://beginnersbook.com/2013/12/jsp-include-with-parameter-example" rel="nofollow">JSP include action with parameter example</a></li>
</ul>
</li>
<li>Вынес общий код в <code>ValidationUtil.getErrorResponse()</code> и сделал обработку через <code>stream()</code></li>
<li>Вместо контекста передаю в <code>makeEditable</code> опции <code>DataTable</code>. Переменную <code>ctx</code> теперь можно создавать не дожидаясь загрузки страницы.</li>
<li>Вынес создание <code>DataTable</code> в <code>topjava.common.js</code>. В параметр конфигурации добавляю общие опции используя <a href="https://api.jquery.com/jquery.extend/#jQuery-extend-deep-target-object1-objectN" rel="nofollow">jQuery.extend()</a></li>
</ul>
</blockquote>
<h4><a id="user-content-apply-10_02_hw9_testpatch" class="anchor" aria-hidden="true" href="#apply-10_02_hw9_testpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_02_HW9_test.patch</h4>
<h4><a id="user-content-apply-10_03_hw9_datetimepickerpatch" class="anchor" aria-hidden="true" href="#apply-10_03_hw9_datetimepickerpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_03_HW9_datetimepicker.patch</h4>
<blockquote>
<ul>
<li>Вынес форматирование даты в <code>topjava.common.formatDate()</code></li>
<li>Изменил формат ввода dateTime в форме без 'T': при биндинге значений к полям формы в <code>topjava.common.updateRow()</code> для поля <code>dateTime</code> вызываю <code>formatDate()</code>.  REST интерфейс по прежнему работает в стандарте ISO-8601</li>
<li>В новой версии <code>datetimepicker</code> работает ограничение выбора времени <code>startTime/endTime</code></li>
<li>Добавил <code>autocomplete="off"</code> для выключения автоподстановки (у некоторых участников мешает вводу, у меня не воспроизводится)</li>
</ul>
</blockquote>
<ul>
<li><a href="http://xdsoft.net/jqplugins/datetimepicker/" rel="nofollow">DateTimePicker jQuery plugin</a></li>
<li><a href="https://github.com/xdan/datetimepicker/issues/216">Datetimepicker and ISO-8601</a></li>
</ul>
<h2><a id="user-content-занятие-10" class="anchor" aria-hidden="true" href="#занятие-10"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Занятие 10:</h2>
<h3><a id="user-content--2-дополнительно-кастомизация-json-jsonview-и-валидации-groups" class="anchor" aria-hidden="true" href="#-2-дополнительно-кастомизация-json-jsonview-и-валидации-groups"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 2. <a href="https://drive.google.com/file/d/0B9Ye2auQ_NsFRTFsTjVHR2dXczA" rel="nofollow">Дополнительно: кастомизация JSON (@JsonView) и валидации (groups)</a></h3>
<p><strong>ВНИМАНИЕ! Патчи <code>10_04_opt</code> и <code>10_05_opt</code> - не обязательные! Если будете делать- то в отдельной ветке (у меня <code>opt_view_group</code>). Это варианты решений, которые не идут в <code>master</code>.</strong></p>
<ul>
<li><a href="https://stackoverflow.com/a/21569720/548473" rel="nofollow">Что возвращать: Entity или DTOs</a></li>
</ul>
<h4><a id="user-content-apply-10_04_opt_json_viewpatch" class="anchor" aria-hidden="true" href="#apply-10_04_opt_json_viewpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_04_opt_json_view.patch</h4>
<ul>
<li><a href="http://www.baeldung.com/jackson-annotations" rel="nofollow">Jackson Annotation </a>
<ul>
<li><a href="http://www.baeldung.com/jackson-json-view-annotation" rel="nofollow">Jackson JSON Views</a></li>
</ul>
</li>
<li><a href="https://habrahabr.ru/post/307392/" rel="nofollow">@JsonView: фильтруем JSON</a></li>
<li><a href="https://stackoverflow.com/questions/22875642/548473" rel="nofollow">Jackson set default view</a></li>
</ul>
<h4><a id="user-content-apply-10_05_opt_validated_groupspatch" class="anchor" aria-hidden="true" href="#apply-10_05_opt_validated_groupspatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_05_opt_validated_groups.patch</h4>
<ul>
<li><a href="https://narmo7.wordpress.com/2014/04/26/how-to-set-up-validation-group-in-springmvc/" rel="nofollow">Validation Group in SpringMVC</a></li>
<li><a href="http://web.archive.org/web/20170826153901/http://forum.spring.io/forum/spring-projects/web/117289-validated-s-given-groups-should-consider-default-group-or-not" rel="nofollow">@Validated and Default group</a></li>
</ul>
<blockquote>
<p><strong>Починил тесты JDBC, добавив при проверке группы валидации.</strong></p>
</blockquote>
<h3><a id="user-content--3-рефакторинг-jquery-конверторы-и-группы-валидации-по-умолчанию" class="anchor" aria-hidden="true" href="#-3-рефакторинг-jquery-конверторы-и-группы-валидации-по-умолчанию"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 3. <a href="https://drive.google.com/file/d/1tOMOdmaP5OQ7iynwC77bdXSs-13Ommax" rel="nofollow">Рефакторинг: jQuery конверторы и группы валидации по умолчанию</a></h3>
<p><strong>ВНИМАНИЕ! далее патчи идут после <code>10_03_HW9_datetimepicker</code> в ветке <code>master</code></strong></p>
<h4><a id="user-content-apply-10_04_jquery_converterspatch" class="anchor" aria-hidden="true" href="#apply-10_04_jquery_converterspatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_04_jquery_converters.patch</h4>
<ul>
<li><a href="https://jquery-docs.ru/jQuery.ajax/#data-types" rel="nofollow">jQuery: типы данных</a></li>
<li><a href="https://jquery-docs.ru/jQuery.ajax/#using-converters" rel="nofollow">jQuery: конверторы</a></li>
</ul>
<blockquote>
<p>В конвертере добавил дополнительную проверки <code>typeof json === 'object'</code> и <code>hasOwnProperty('dateTime')</code>, т.к. <a href="https://stackoverflow.com/questions/48229776/548473" rel="nofollow">при ексепшене не переопределяется <code>jqXHR.responseJSON</code></a></p>
</blockquote>
<h4><a id="user-content-apply-10_05_persist_validate_grouppatch" class="anchor" aria-hidden="true" href="#apply-10_05_persist_validate_grouppatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_05_persist_validate_group.patch</h4>
<ul>
<li><a href="https://stackoverflow.com/a/16930663/548473" rel="nofollow">Default Hibernate validation</a>. Т.к.  <code>Persist</code> наследуется от <code>javax.validation.groups.Default</code>, при сохранении учитываются все непомеченные аннотации валидации (<code>Default</code>) + помеченные <code>Persist</code>.</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="question" style="max-width:100%;"></a>
При <code>NotNull(groups = View.Persist.class)</code> валидация происходит непосредственно перед созданием или редактированием на уровне репозиториев? А если бы мы установили без группы то проверка была сразу после получения с UI?</p>
</blockquote>
<p>Если <code>View</code> никаких нет (что равнозначно <code>javax.validation.groups.Default</code>), то бины, в которых есть аннотации валидации, проверяют Spring в контроллерах (если перед параметром стоит <code>@Valid</code>) и Hibernate перед сохранением и обновлением. Через <code>View</code> мы можем управлять валидацией. В нашем случае мы включили в <code>spring-db.xml</code> указание Hibernate валидировать поля с <code>View.Persist</code>. Так как <code>View.Persist</code> наследуется от <code>Default</code>, то Hibernate будет также валидировать и поля, на которых нет View.</p>
<h3><a id="user-content--4-spring-security-taglib-method-security-expressions" class="anchor" aria-hidden="true" href="#-4-spring-security-taglib-method-security-expressions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 4. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFTVZyQnBlYUtkNms" rel="nofollow">Spring Security Taglib. Method Security Expressions.</a></h3>
<h4><a id="user-content-apply-10_06_secure_tag_annotationpatch" class="anchor" aria-hidden="true" href="#apply-10_06_secure_tag_annotationpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_06_secure_tag_annotation.patch</h4>
<blockquote>
<ul>
<li>Сделал общий <code>bodyHeader.jsp</code> с разделением <code>isAnonymous/isAuthenticated</code></li>
<li>В <code>login.jsp</code> кнопки входа отображаю только для <code>isAnonymous</code></li>
</ul>
</blockquote>
<ul>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#declaring-the-taglib" rel="nofollow">Spring Security Taglib.</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#jc-method" rel="nofollow">Method Security</a> и <a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#method-security-expressions" rel="nofollow">Method Security Expressions</a>.</li>
</ul>
<h4><a id="user-content--вопрос" class="anchor" aria-hidden="true" href="#-вопрос"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="question" style="max-width:100%;"></a> Вопрос:</h4>
<blockquote>
<p>У нас в <code>sprng-mvc</code> подключается <code>spring-app</code>, в который подключается <code>spring-security</code>. Т.о. <code>spring-mvc</code>  в себе содержит код <code>spring-app</code> и <code>spring-security</code>. Почему тогда аннотация <code>&lt;security:global-method-security...</code> из <code>spring-security</code> не видна для контроллера из <code>spring-mvc</code>?</p>
</blockquote>
<ol>
<li>Подключаем один контекст внутрь другого: это про import а не про наследование (тоже самое что скопипастить сюда xml из подключаемого import файла). Наследование означает, что поиск бина, если он не найден, происходит в родителе.</li>
<li>При создании контекста аннотация <code>&lt;security:global-method-security...</code> говорит про то, что все бины текущего контекста, у которых есть аннотации авторизации (<code>@PreAuthorize/ @Secured/ ..</code>) будут проксироваться с проверкой авторизации. Контексты родителей и детей создаются сами по себе и аннотации проксирования у них собственные.</li>
</ol>
<h3><a id="user-content--5--interceptors-редактирование-профиля-jsp-tag-files" class="anchor" aria-hidden="true" href="#-5--interceptors-редактирование-профиля-jsp-tag-files"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 5.  <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFc1JMTE4xVG0zN0U" rel="nofollow">Interceptors. Редактирование профиля. JSP tag files.</a></h3>
<h4><a id="user-content-apply-10_07_interceptorpatch" class="anchor" aria-hidden="true" href="#apply-10_07_interceptorpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_07_interceptor.patch</h4>
<ul>
<li><a href="http://www.mkyong.com/spring-mvc/spring-mvc-handler-interceptors-example/" rel="nofollow">Spring interceptors</a>.</li>
</ul>
<h4><a id="user-content-apply-10_08_profile_jsptagpatch" class="anchor" aria-hidden="true" href="#apply-10_08_profile_jsptagpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_08_profile_jsptag.patch</h4>
<p><strong>Глюк Хрома - у меня поле <code>email</code> у User показывается неверно (как для admin). В другом браузере, анонимном окне и коде страницы (Ctrl+U) все ок. Я решил локально обновлением Хрома. Еще решения:</strong></p>
<ul>
<li><a href="https://www.howtogeek.com/425270/how-to-disable-form-autofill-in-google-chrome" rel="nofollow">В своем браузере</a></li>
<li><a href="https://stackoverflow.com/questions/12374442/548473" rel="nofollow">Chrome ignores autocomplete=“off”</a></li>
<li><a href="https://stackoverflow.com/questions/15738259/548473" rel="nofollow">Disabling Chrome Autofill</a></li>
</ul>
<blockquote>
<ul>
<li>Создал отдельный <code>ProfileUIController</code> для операций с профилем (вместо <code>RootController</code>)</li>
<li>Упростил: в <code>inputField.tag</code>: передаю для label код локализации и убрал ветвление</li>
<li>В профиль добавил кнопку "Cancel"</li>
</ul>
</blockquote>
<ul>
<li><a href="http://nicesnippets.com/snippet/bootstrap-4-form-validation-with-form-all-input-example" rel="nofollow">Bootstrap 4 form validation example</a></li>
<li><a href="http://www.techrepublic.com/article/an-introduction-to-jsp-20s-tag-files/" rel="nofollow">Делаем jsp tag для ввода поля формы</a>.</li>
<li><a href="http://www.codejava.net/frameworks/spring/spring-mvc-form-validation-example-with-bean-validation-api" rel="nofollow">Spring MVC Form Validation</a></li>
<li><a href="http://www.mkyong.com/spring-mvc/spring-mvc-form-check-if-a-field-has-an-error/" rel="nofollow">Spring MVC Form: check if a field has an error</a></li>
</ul>
<h3><a id="user-content--6-форма-регистрации" class="anchor" aria-hidden="true" href="#-6-форма-регистрации"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 6. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFNWpUNktMeGJURmM" rel="nofollow">Форма регистрации.</a></h3>
<h4><a id="user-content-apply-10_09_registrationpatch" class="anchor" aria-hidden="true" href="#apply-10_09_registrationpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_09_registration.patch</h4>
<blockquote>
<ul>
<li>Добавил локализацию</li>
<li>При регистрации передаю <code>username</code> в <code>login.jsp</code> как параметр и делаю <code>setCredentials</code> (пароль вводится скрыто, поэтому его не передаю из соображений безопасности). Т.к <code>setCredentials</code> требует jQuery, убрал для него <code>defer</code></li>
<li>Поменял путь регистрации с <code>/registered</code> на <code>/profile/registered</code> (в <code>ProfileUIController</code> вместо <code>RootController</code>)</li>
<li>Добавил регистрацию пользователя по REST: <code>ProfileRestController.register</code>, тест и пример <code>curl</code>. Обратите внимание на хедер <code>Location</code>, он отличается от <code>AdminRestController.createWithLocation</code></li>
</ul>
</blockquote>
<h3><a id="user-content--7-обработка-исключений-в-spring" class="anchor" aria-hidden="true" href="#-7-обработка-исключений-в-spring"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 7. <a href="https://drive.google.com/file/d/0B9Ye2auQ_NsFZ19lU29VVDRfNXM" rel="nofollow">Обработка исключений в Spring.</a></h3>
<h4><a id="user-content-apply-10_10_not_found_422patch" class="anchor" aria-hidden="true" href="#apply-10_10_not_found_422patch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_10_not_found_422.patch</h4>
<blockquote>
<p><a href="http://stackoverflow.com/a/22358422/548473" rel="nofollow">Поменял код 404 (URL not found) на 422 (Unprocessable Entity)</a></p>
</blockquote>
<ul>
<li><a href="http://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc#using-http-status-codes" rel="nofollow">Используем HTTP status code</a></li>
</ul>
<h4><a id="user-content-apply-10_11_global_exceptionpatch" class="anchor" aria-hidden="true" href="#apply-10_11_global_exceptionpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_11_global_exception.patch</h4>
<blockquote>
<ul>
<li>Перед  отображением exception предварительно делаю <code>ValidationUtil.getRootCause</code></li>
<li>Добавил локализацию</li>
<li>Добавил общий статус <code>500</code> в ответ и отображение (на следующем уроке будем его менять, в зависимости от типа ошибки)</li>
</ul>
</blockquote>
<ul>
<li><a href="http://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc#global-exception-handling" rel="nofollow">Global Exception Handling</a></li>
</ul>
<h4><a id="user-content-apply-10_12_controller_advice_exceptionpatch" class="anchor" aria-hidden="true" href="#apply-10_12_controller_advice_exceptionpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_12_controller_advice_exception.patch</h4>
<p><strong>Отображение валидации для формы еды и юзера пропало (<code>TODO</code> в коде для HW10). Можно посмотреть сериализацию в <code>ErrorInfo</code> при попытке добавить юзера с дублирующимся email.</strong></p>
<blockquote>
<ul>
<li>Добавил в <code>ErrorInfo</code> тип ошибки <code>ErrorType</code></li>
<li>Добавил обработку неверного запроса (<code>IllegalRequestDataException</code>)</li>
<li><code>@ResponseBody</code> над методами <code>ExceptionInfoHandler</code> заменил на <code>@RestControllerAdvice</code></li>
<li>В <code>ExceptionInfoHandler</code> удалил <code>@Order</code> над методами и добавил над классом:</li>
</ul>
</blockquote>
<pre><code>  Methods are matched by closest exception in
  *  @see  org.springframework.web.method.annotation.ExceptionHandlerMethodResolver#getMappedMethod
  *  164: Collections.sort(matches, new ExceptionDepthComparator(exceptionType))
</code></pre>
<blockquote>
<ul>
<li>Добавил в <code>curl.md</code> пример с возвращением <code>ErrorInfo</code>. Локализация ошибок будет на последнем занятии</li>
</ul>
</blockquote>
<ul>
<li><a href="http://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc#errors-and-rest" rel="nofollow">Сериализация Exception в JSON</a></li>
<li><a href="http://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc#controller-based-exception-handling" rel="nofollow">Exception Handling на уровне контроллера</a></li>
<li><a href="https://www.javacodegeeks.com/2013/11/controlleradvice-improvements-in-spring-4.html" rel="nofollow">@ControllerAdvice improvements in Spring 4</a></li>
<li><a href="https://dzone.com/articles/spring-31-valid-requestbody" rel="nofollow">@Valid @RequestBody + Error handling</a></li>
</ul>
<h3><a id="user-content--8-encoding-password-json-readwrite-access" class="anchor" aria-hidden="true" href="#-8-encoding-password-json-readwrite-access"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 8. <a href="https://drive.google.com/file/d/1XZXvOThinzPw4EhigAUdo8-MWT_g8wOt" rel="nofollow">Encoding password. Json READ/WRITE access</a></h3>
<h4><a id="user-content-apply-10_13_password_encodingpatch" class="anchor" aria-hidden="true" href="#apply-10_13_password_encodingpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_13_password_encoding.patch</h4>
<blockquote>
<ul>
<li>Добавил утильный метод <code>UserService.prepareAndSave</code></li>
<li>Для InMemory тестов добавил <code>passwordEncoder</code> в  <code>inmemory.xml</code></li>
</ul>
</blockquote>
<ul>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#core-services-password-encoding" rel="nofollow">Password Encoding</a></li>
</ul>
<h4><a id="user-content-apply-10_14_read_write_accesspatch" class="anchor" aria-hidden="true" href="#apply-10_14_read_write_accesspatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_14_read_write_access.patch</h4>
<blockquote>
<ul>
<li>Добавил методы сериализации в json <code>JsonUtil.writeAdditionProps</code> с дополнительными полями и <code>UserTestData.jsonWithPassword</code> для того,
чтобы передавать в контроллер пользователя с паролем (который теперь не сериализуется)</li>
</ul>
</blockquote>
<h3><a id="user-content-в-реальном-приложении-для-управления-паролем-необходим-отдельный-ui-интерфейс-с-подтверждением-старого-пароля---одна-из-ваших-доработок-проекта-по-окончанию-стажировки" class="anchor" aria-hidden="true" href="#в-реальном-приложении-для-управления-паролем-необходим-отдельный-ui-интерфейс-с-подтверждением-старого-пароля---одна-из-ваших-доработок-проекта-по-окончанию-стажировки"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>В реальном приложении для управления паролем необходим отдельный UI интерфейс с подтверждением старого пароля - одна из ваших доработок проекта по окончанию стажировки</h3>
<ul>
<li><a href="https://stackoverflow.com/a/12505165/548473" rel="nofollow">@JsonProperty READ_ONLY / WRITE_ONLY</a></li>
</ul>
<h3><a id="user-content--9-межсайтовая-подделка-запроса-csrf" class="anchor" aria-hidden="true" href="#-9-межсайтовая-подделка-запроса-csrf"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 9. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFNDlPZGdUNThzNUU" rel="nofollow">Межсайтовая подделка запроса (CSRF).</a></h3>
<h4><a id="user-content-apply-10_15_csrfpatch" class="anchor" aria-hidden="true" href="#apply-10_15_csrfpatch"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Apply 10_15_csrf.patch</h4>
<blockquote>
<p>Убрал <code>form:form</code> из ajax запросов: там csrf работает через header. Проверьте во вкладке браузера <code>Network</code>.</p>
</blockquote>
<p><strong>Поломалась UTF-8 кодировка в редактировании профиля и регистрациию (если по умолчанию не UTF-8). В Optional HW10 нужно будет починить.</strong></p>
<ul>
<li><a id="user-content-csrf"></a><a href="https://ru.wikipedia.org/wiki/Межсайтовая_подделка_запроса" rel="nofollow">Межсайтовая подделка запроса (CSRF)</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/features.html#csrf" rel="nofollow">Using Spring Security CSRF Protection</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/features.html#csrf-when-json" rel="nofollow">Ajax and JSON Requests</a></li>
<li><a href="http://blog.jdriven.com/2014/10/stateless-spring-security-part-1-stateless-csrf-protection/" rel="nofollow">Stateless CSRF protection</a></li>
<li>Ресурсы:
<ul>
<li><a href="http://habrahabr.ru/post/264641/" rel="nofollow">Spring Security 4 + CSRF</a></li>
<li><a href="http://stackoverflow.com/questions/11008469/are-json-web-services-vulnerable-to-csrf-attacks" rel="nofollow">Are JSON web services vulnerable to CSRF attacks</a></li>
<li><a href="https://ru.wikipedia.org/wiki/Правило_ограничения_домена" rel="nofollow">Правило ограничения домена (SOP)</a></li>
<li><a href="https://ru.wikipedia.org/wiki/Cross-origin_resource_sharing" rel="nofollow">Cross-origin resource sharing (CORS)</a></li>
</ul>
</li>
</ul>
<h2><a id="user-content--ваши-вопросы" class="anchor" aria-hidden="true" href="#-ваши-вопросы"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="question" style="max-width:100%;"></a> Ваши вопросы</h2>
<blockquote>
<p>В чем отличие между аннотоацией <code>@PreAuthorize("hasRole('ADMIN')")</code> и конфигурацией в jsp: <code>&lt;sec:authorize access="isAuthenticated()"&gt;</code>, <code>&lt;sec:authorize access="hasRole('ADMIN')"&gt;</code> ?</p>
</blockquote>
<p>Анотация <code>@PreAuthorize</code> обрабатывается Spring анологично <code>@Transactional</code>, <code>@Cacheable</code> - класс проксируется и до-после вызова метода добавляется функциональность.
В данном случае перед вызовом метода проверяются роль залогиненного юзера. JSTL тэг <code>authorize</code> выполняет проверку условия в залогиненном юзере внутри jsp.</p>
<blockquote>
<p>Еще раз: почему не нужен csrf для REST и нельзя подделать JSON запрос с вредоносного сайта?</p>
</blockquote>
<p>Попробуйте выполнить ajax запрос из вашего приложения c url, у которого домен отличный от вашего (например '<a href="http://topjava.herokuapp.com/meals/ajax/admin/users/%7Bid%7D" rel="nofollow">http://topjava.herokuapp.com/meals/ajax/admin/users/{id}</a>').
В консоли браузера будет <code>XMLHttpRequest cannot load</code>... - <a href="https://developer.chrome.com/extensions/xhr" rel="nofollow">нарушение same origin policy</a>.
Формам же разрешается делать submit (через <code>action=..</code>) на другой домен, но невозможно cделать <code>Content-Type</code>, отличный от <a href="http://htmlbook.ru/html/form/enctype" rel="nofollow">стндартных enctype</a> и методов <a href="http://htmlbook.ru/html/form/method" rel="nofollow">кроме get и post</a>. Таким образом <code>consumes = MediaType.APPLICATION_JSON_VALUE</code> в POST защищает приложение от CSRF.</p>
<blockquote>
<p>Почему использован <code>BCryptPasswordEncoder</code>а не <code>hash(password+salt)</code>?</p>
</blockquote>
<p><a href="http://stackoverflow.com/a/8528804/548473" rel="nofollow"><code>BCryptPasswordEncoder</code> automatically generates a salt and concatenates it with the hash value in a single String</a>.</p>
<blockquote>
<p>Когда запускается в <code>GlobalExceptionHandler</code> метод <code>defaultErrorHandler</code>? Когда как в него исключение попадает? Как выбирается, кто обрабатывает исключения: <code>ExceptionInfoHandler</code> или <code>GlobalExceptionHandler</code>?</p>
</blockquote>
<p><code>GlobalExceptionHandler</code> попадает в контекст спринг (через <code>@ControllerAdvice</code> его находят в пакете <code>web</code>). Далее спринг перехватывает исключения и отправляет в подходящий по исключению метод <code>GlobalExceptionHandler</code>. <code>ExceptionInfoHandler</code> помечен <code>@RestControllerAdvice(annotations = RestController.class)</code>, он обрабатывает только ошибки из всех контроллеров с аннотацией <code>RestController</code>.</p>
<blockquote>
<p>Откуда берутся в валидации сообщения на русском "должно быть между 10 и 10000"?</p>
</blockquote>
<p>Локализация встроена в Hibernate Validation. Смотрите <code>Ctrl+Shift+N</code> и <code>ValidationMessages_ru.properties</code>.</p>
<h2><a id="user-content--домашнее-задание-hw10" class="anchor" aria-hidden="true" href="#-домашнее-задание-hw10"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png" alt="hw" style="max-width:100%;"></a> Домашнее задание HW10</h2>
<ul>
<li>1: Сделать валидацию в <code>AdminUIController/MealUIController</code> через <code>ExceptionInfoHandler</code>. Вернуть клиенту <code>ErrorInfo</code> и статус <code>HttpStatus.UNPROCESSABLE_ENTITY</code> (тип методов контроллеров сделать <code>void</code>). Ошибки валидации отобразить на клиенте красиво (так, как это сделано в <a href="http://topjava.herokuapp.com" rel="nofollow">demo</a>, без локализации полей)</li>
<li>2: Сделать валидацию принимаемых json объектов в REST контроллерах через <code>ExceptionInfoHandler</code>. Добавить в Rest контроллеры тест для невалидных данных.
<ul>
<li><a href="https://dzone.com/articles/spring-31-valid-requestbody" rel="nofollow">@Valid @RequestBody + Error handling</a></li>
</ul>
</li>
<li>3: Сделать обработку ошибки при дублирования email (вывод сообщения "User with this email already exists") для:
<ul>
<li>3.1 регистрации / редактирования профиля пользователя</li>
<li>3.2 добавления / редактирования пользователя в таблице</li>
<li>3.3 REST контроллеров<br>
Варианты выполнения:
<ul>
<li>через <code>catch DataIntegrityViolationException</code></li>
<li>обработку ошибок в  <code>@ExceptionHandler</code>(<a href="https://stackoverflow.com/a/42422568/548473" rel="nofollow">https://stackoverflow.com/a/42422568/548473</a>)</li>
<li>более сложная реализация - <a href="https://coderlessons.com/articles/java/spring-mvc-validator-i-initbinder" rel="nofollow">собственный валидатор</a></li>
</ul>
</li>
<li>Опционально - <a href="https://www.logicbig.com/tutorials/spring-framework/spring-core/message-sources.html" rel="nofollow">сделать локализацию выводимой ошибки</a></li>
</ul>
</li>
</ul>
<h3><a id="user-content-optional" class="anchor" aria-hidden="true" href="#optional"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Optional</h3>
<ul>
<li>4: Сделать обработку ошибки при дублирования dateTime еды. Сделать тесты на дублирование email и dateTime.
<ul>
<li><a href="http://stackoverflow.com/questions/37406714/548473" rel="nofollow">Тесты на DB exception c @Transactional</a></li>
<li><a href="https://stackoverflow.com/questions/18336277/548473" rel="nofollow">Сheck String in response body with mockMvc</a></li>
</ul>
</li>
<li>5: Сделать в приложении выбор локали (см. <a href="http://topjava.herokuapp.com/" rel="nofollow">http://topjava.herokuapp.com/</a>)
<ul>
<li><a href="https://terasolunaorg.github.io/guideline/5.0.x/en/ArchitectureInDetail/Internationalization.html" rel="nofollow">Internationalization</a></li>
<li><a href="http://www.mkyong.com/spring-mvc/spring-mvc-internationalization-example" rel="nofollow">Spring MVC internationalization sample</a></li>
<li><a href="https://www.concretepage.com/spring-4/spring-mvc-internationalization-localization" rel="nofollow">Spring 4 MVC Internationalization</a></li>
</ul>
</li>
<li>6: Починить UTF-8 в редактировании профиля и регистрации (если кодировка по умолчанию у вас не UTF-8). Подумайте, почему кодировка поломалась.</li>
</ul>
<hr>
<h2><a id="user-content--типичные-ошибки-и-подсказки-по-реализации" class="anchor" aria-hidden="true" href="#-типичные-ошибки-и-подсказки-по-реализации"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png" alt="error" style="max-width:100%;"></a> Типичные ошибки и подсказки по реализации</h2>
<ul>
<li>1: <code>ErrorInfo</code> просто бин для передачи информации на клиента. Кода возврата и ответ настраиваются в <code>ExceptionInfoHandler</code>.</li>
<li>2: Не дублируйте обработку ошибок <code>BindingResult</code>: <code>result.getFieldErrors()..</code></li>
<li>3: Можно не создавать собственные эксепшены, а в <code>ExceptionInfoHandler</code> ловить стандартные</li>
<li>4: в <code>MethodArgumentNotValidException</code> также есть <code>e.getBindingResult()</code>, его можно обрабатывать по аналогии с <code>BindException</code></li>
<li>5: Не дублируйте код переключения локали на странице логина и в приложении</li>
<li>6: При проблемах с валидацией <code>Meals</code> в <code>MealRestController</code>, посмотрите на валидацию в <code>MealUIController.updateOrCreate</code></li>
<li>7: Импорт класса <code>java.net.BindException</code> вместо нужного <code>javax.validation.BindException</code></li>
</ul>
</article>
<article class="markdown-body entry-content container-lg" itemprop="text">
    <h1>
        <a id="user-content-онлайн-проект-topjava" class="anchor" aria-hidden="true" href="#онлайн-проект-topjava">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Онлайн-проект <a href="https://github.com/JavaWebinar/topjava">Topjava</a>
    </h1>
    <h2>
        <a id="user-content-материалы-занятия" class="anchor" aria-hidden="true" href="#материалы-занятия">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a href="https://drive.google.com/drive/folders/0B9Ye2auQ_NsFfmctT3oyNW1qaVhDb2p0bGpyTFVlaUJ2VVpOdVgtWF9KTUFBMWFaR2xVYVE" rel="nofollow">Материалы занятия</a>
    </h2>
    <h2>
        <a id="user-content--1-обзор-jdk-911-миграция-topjava-с-18-на-jdk-15" class="anchor" aria-hidden="true" href="#-1-обзор-jdk-911-миграция-topjava-с-18-на-jdk-15">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 1. <a href="http://javaops.ru/view/resources/jdk8_11" rel="nofollow">Обзор JDK 9/11. Миграция Topjava с 1.8 на JDK 15</a>
    </h2>
    <h3>
        <a id="user-content-внимание-для-jdk-15-обновите-idea-на-последнюю-версию-и-tomcat-на-9x" class="anchor" aria-hidden="true" href="#внимание-для-jdk-15-обновите-idea-на-последнюю-версию-и-tomcat-на-9x">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Внимание: для JDK 15 обновите IDEA на последнюю версию и Tomcat на 9.x
    </h3>
    <blockquote>
        <ul>
            <li>Проект обновил до JDK 15. Для запуска Maven или Tomcat переопредели переменную окружения <code>JAVA_HOME</code> и переменную <code>path</code>, чтобы  <code>java -version</code> тоже было 15. Напомню, что IDEA это java процесс. Чтобы новые переменные окружения в ней увиделись, требуется ее перегрузить.</li>
        </ul>
    </blockquote>
    <ul>
        <li><a href="https://habr.com/ru/post/485750" rel="nofollow">API, ради которых наконец-то стоит обновиться с Java 8 (1)</a></li>
        <li><a href="https://habr.com/ru/post/487636" rel="nofollow">API, ради которых наконец-то стоит обновиться с Java 8 (2)</a></li>
    </ul>
    <h4>
        <a id="user-content-apply-5_1_jdk_15patch" class="anchor" aria-hidden="true" href="#apply-5_1_jdk_15patch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_1_jdk_15.patch
    </h4>
    <ul>
        <li><a href="https://stackoverflow.com/questions/48204141/replacements-for-deprecated-jpms-modules-with-java-ee-apis" rel="nofollow">Добавил javax зависимости</a></li>
        <li>Сделал создание коллекций через фабричные методы <code>List.of</code></li>
        <li>
            Как пример в <code>InMemoryMealRepository</code> использовал <em>local variable type inference</em> <code>var</code>.
            <ul>
                <li><a href="https://habr.com/ru/post/438206/" rel="nofollow">26 рекомендаций по использованию типа var в Java</a></li>
            </ul>
        </li>
        <li>
            <code>switch</code> в <code>MealServlet</code> перевел на новый формат (IDEA сама переводит по Alt+Enter).
            <ul>
                <li><a href="https://habr.com/ru/post/443464/" rel="nofollow">Новые switch выражения</a></li>
            </ul>
        </li>
        <li>В <code>JdbcUserRepository.save</code> использовал <a href="https://www.infoq.com/articles/java-text-blocks/" rel="nofollow">Text Blocks</a></li>
    </ul>
    <h2>
        <a id="user-content--разбор-домашнего-задания-hw4" class="anchor" aria-hidden="true" href="#-разбор-домашнего-задания-hw4">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png" alt="hw" style="max-width:100%;"></a> Разбор домашнего задания HW4
    </h2>
    <h3>
        <a id="user-content--2-hw4-meal--jpamealrepository" class="anchor" aria-hidden="true" href="#-2-hw4-meal--jpamealrepository">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 2. <a href="https://drive.google.com/file/d/13JJRhLhkn8_C3-xpkyilRxGe_w9_xTF2" rel="nofollow">HW4: Meal / JpaMealRepository</a>
    </h3>
    <h4>
        <a id="user-content-apply-5_2_hw4patch" class="anchor" aria-hidden="true" href="#apply-5_2_hw4patch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_2_HW4.patch
    </h4>
    <ul>
        <li>При сравнении еды тесты падают, т.к. Hibernate делает ленивую обертку к <code>user</code>, и если происходит обращение к любому его полю (кроме id) вне транзакции, бросается <code>LazyInitializationException</code>.
            По логике приложения поле <code>user</code> в еде не нужно, и мы не будем его отдавать наружу UI. Более того, включать <code>user</code> в запрос будет ошибкой: мы запрашиваем данные, которые приложению не требуются.
            В тестах исключаем <code>user</code> из сравнения.
        </li>
        <li><a href="https://stackoverflow.com/questions/16347649/sql-between-not-inclusive/16347680" rel="nofollow">SQL “between” not inclusive</a></li>
    </ul>
    <h3>
        <a id="user-content--3-hibernate-issue--hw4-optional" class="anchor" aria-hidden="true" href="#-3-hibernate-issue--hw4-optional">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 3. <a href="https://drive.google.com/file/d/1kbb2IO15L9ABJ0-2TFJm8XZU_QUXUdni" rel="nofollow">Hibernate issue / HW4 Optional</a>
    </h3>
    <h4>
        <a id="user-content-apply-5_3_fix_hibernate_issuepatch" class="anchor" aria-hidden="true" href="#apply-5_3_fix_hibernate_issuepatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_3_fix_hibernate_issue.patch
    </h4>
    <ul>
        <li>
            Из-за <a href="https://hibernate.atlassian.net/browse/HHH-3718" rel="nofollow">Hibernate bug with proxy initialization when using <code>AccessType.FIELD</code></a>
            в <code>JpaMealRepository.get()</code> делался дополнительный запрос в базу для инициализации прокси <code>User</code>, и мы делали хак: доступ к полю <code>AbstractBaseEntity.id</code> через <code>AccessType.PROPERTY</code>.
            С версии <code>5.2.13.Final</code> загрузка прокси при обращении к <code>id</code> управляется флагом <code>JPA_PROXY_COMPLIANCE</code> (по умолчанию запрос не делается)
            <ul>
                <li><a href="https://hibernate.atlassian.net/browse/HHH-3718" rel="nofollow">Call to id getter initializes proxy when using AccessType( "field" ): HHH-3718</a></li>
                <li><a href="https://hibernate.atlassian.net/browse/HHH-12034" rel="nofollow">According to JPA, a Proxy should be loaded even when accessing the identifier: HHH-12034</a></li>
            </ul>
        </li>
        <li><a href="http://stackoverflow.com/questions/594597/hibernate-annotations-which-is-better-field-or-property-access" rel="nofollow">Which is better, field or property access?</a></li>
        <li>
            Поправил <code>equals()</code> с учетом Lazy-проксирования
            <ul>
                <li><a href="http://stackoverflow.com/questions/5031614/the-jpa-hashcode-equals-dilemma" rel="nofollow">JPA hashCode()/equals() dilemma</a></li>
                <li><a href="http://blog.xebia.com/advanced-hibernate-proxy-pitfalls/" rel="nofollow">Hibernate Proxy Pitfalls</a></li>
            </ul>
        </li>
    </ul>
    <hr>
    <blockquote>
        <p>Переопределять <code>equals()/hashCode()</code> необходимо, если</p>
        <ul>
            <li>использовать entity в <code>Set</code> (рекомендовано для Many-ассоциаций) либо как ключи в <code>HashMap</code></li>
            <li>использовать <em>reattachment of detached instances</em> (т.е. манипулировать одним Entity в нескольких транзакциях/сессиях).</li>
        </ul>
    </blockquote>
    <blockquote>
        <p><a href="https://access.redhat.com/documentation/en-us/jboss_enterprise_application_platform/4.3/html/hibernate_reference_guide/persistent_classes-implementing_equals_and_hashcode" rel="nofollow">Implementing equals() and hashCode()</a></p>
    </blockquote>
    <blockquote>
        <p>Оптимально использовать уникальные бизнес-поля, но обычно таких нет, и чаще всего используются PK с ограничением, что он может быть <code>null</code> у новых объектов, и нельзя объекты сравнивать через <code>equals() and hashCode()</code> в бизнес-логике (например, тестах).</p>
    </blockquote>
    <blockquote>
        <p><a href="https://stackoverflow.com/questions/1638723" rel="nofollow">equals() and hashcode() when using JPA and Hibernate</a></p>
    </blockquote>
    <hr>
    <blockquote>
        <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="question" style="max-width:100%;"></a> Почему над <code>AbstractBaseEntity</code> стоит <code>@Access(AccessType.FIELD)</code> ? Почему при запросе <code>user.id</code> нам не нужно вытаскивать его из базы?</p>
    </blockquote>
    <p><code>AccessType.FIELD</code> делает доступ в <code>AbstractBaseEntity</code> и всех классах-наследниках по полям. При загрузке <code>Meal</code> Hibernate на основе поля <code>meal.user_id</code> делает ленивую прокси к <code>User</code>, у которой нет ничего, кроме id.</p>
    <h4>
        <a id="user-content-apply-5_4_hw4_optionalpatch" class="anchor" aria-hidden="true" href="#apply-5_4_hw4_optionalpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_4_HW4_optional.patch
    </h4>
    <ul>
        <li><a href="http://stackoverflow.com/questions/14892125/what-is-the-best-practice-to-determine-the-execution-time-of-the-bussiness-relev#27868954" rel="nofollow">Stopwatch</a></li>
        <li><a href="https://logback.qos.ch/manual/layouts.html#coloring" rel="nofollow">Logback layouts coloring</a></li>
        <li>Дополнительно: <a href="https://stackoverflow.com/questions/31046748" rel="nofollow">use colored output only when logging to a real terminal</a></li>
    </ul>
    <h2>
        <a id="user-content-занятие-5" class="anchor" aria-hidden="true" href="#занятие-5">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Занятие 5:
    </h2>
    <h3>
        <a id="user-content--4-транзакции" class="anchor" aria-hidden="true" href="#-4-транзакции">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 4. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFZENCVEhDMkZiV00" rel="nofollow">Транзакции</a>
    </h3>
    <ul>
        <li><a href="https://ru.wikipedia.org/wiki/Транзакция_(информатика)" rel="nofollow">wiki Транзакция</a></li>
        <li><a href="https://jira.spring.io/browse/DATAJPA-601" rel="nofollow">readOnly и Propagation.SUPPORTS</a></li>
        <li>
            Ресурсы:
            <ul>
                <li><a href="https://medium.com/@kirill.sereda/%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B8-%D0%B2-spring-framework-a7ec509df6d2" rel="nofollow">Транзакции в Spring Framework</a></li>
                <li><a href="https://dzone.com/articles/how-does-spring-transactional" rel="nofollow">How does Spring @Transactional Really Work</a></li>
                <li><a href="https://www.ibm.com/developerworks/ru/library/j-ts1/" rel="nofollow">Стратегии работы с транзакциями: распространенные ошибки</a></li>
                <li><a href="http://stackoverflow.com/questions/8490852/spring-transactional-isolation-propagation" rel="nofollow">Spring @Transactional - isolation, propagation</a></li>
            </ul>
        </li>
    </ul>
    <h3>
        <a id="user-content--5-профили-maven-и-spring" class="anchor" aria-hidden="true" href="#-5-профили-maven-и-spring">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 5. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFNW0yVWhXcGNPU2M" rel="nofollow">Профили Maven и Spring</a>
    </h3>
    <h4>
        <a id="user-content-apply-5_5_profiles_connection_poolpatch" class="anchor" aria-hidden="true" href="#apply-5_5_profiles_connection_poolpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_5_profiles_connection_pool.patch
    </h4>
    <blockquote>
        <ul>
            <li><code>SLF4JBridgeHandler</code> перенес в профиль <code>postgres</code> (если логировать драйвер не нужно, то и он не нужен)</li>
            <li><strong>Галочка в XML-профиле влияет только на отображение в IDEA и никак не влияет на выполнение кода.</strong></li>
            <li>Перенес класс <code>Profiles</code> в сорсы тестов</li>
            <li><code>Profiles.ACTIVE_DB</code> задает активный профиль базы (postgres/hsqldb)</li>
            <li><code>Profiles.REPOSITORY_IMPLEMENTATION</code> определяет реализацию репозитория при запуске приложения (для тестов задаются через <code>@ActiveProfiles</code>).</li>
        </ul>
    </blockquote>
    <blockquote>
        <p>Для переключения на HSQLDB необходимо:</p>
        <ul>
            <li>поменять в окне Maven Projects профиль (Profiles) - выключить <code>postgres</code>, включить <code>hsqldb</code> -  и сделать <code>Reimport All Maven Projects</code> (1-я кнопка)</li>
            <li>поменять <code>Profiles.ACTIVE_DB = HSQLDB</code></li>
            <li>почистить проект <code>mvn clean</code> (фаза <code>clean</code> не выполняется автоматически, чтобы каждый раз не перекомпилировать весь проект)</li>
        </ul>
    </blockquote>
    <p>Для корректного отображения неактивного профиля в IDEA проверьте флаг <em>Inactive profile highlighting</em> и сделайте проекту clean</p>
    <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/25120020/29935958-2425-11e7-8363-1ff027426f64.png"><img src="https://cloud.githubusercontent.com/assets/13649199/25120020/29935958-2425-11e7-8363-1ff027426f64.png" alt="image" style="max-width:100%;"></a></p>
    <blockquote>
        <p>Вопрос: почему после этого патча не поднимается Spring при запуске приложения в Tomcat? (будем чинить в ДЗ, п.6)</p>
    </blockquote>
    <ul>
        <li><a href="https://dzone.com/articles/using-spring-profiles-xml" rel="nofollow">Using Spring Profiles in XML Config</a></li>
        <li><a href="https://www.mkyong.com/spring/spring-profiles-example/" rel="nofollow">Spring Profiles example</a></li>
    </ul>
    <h3>
        <a id="user-content-автоматический-выбор-профиля-базы-activeprofilesresolver" class="anchor" aria-hidden="true" href="#автоматический-выбор-профиля-базы-activeprofilesresolver">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Автоматический выбор профиля базы: <a href="http://stackoverflow.com/questions/23871255/spring-profiles-simple-example-of-activeprofilesresolver" rel="nofollow"><code>ActiveProfilesResolver</code></a>
    </h3>
    <h4>
        <a id="user-content-apply-5_6_profile_resolverpatch" class="anchor" aria-hidden="true" href="#apply-5_6_profile_resolverpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_6_profile_resolver.patch
    </h4>
    <blockquote>
        <p>Сделал автоматический выбор профиля базы при запуске приложения (тестов) в зависимости от присутствия драйвера базы в classpath (<code>Profiles.getActiveDbProfile</code>). <code>ActiveDbProfileResolver</code> сделал внутренним классом <code>Profiles</code></p>
    </blockquote>
    <h3>
        <a id="user-content--6-пул-коннектов" class="anchor" aria-hidden="true" href="#-6-пул-коннектов">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 6. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFTWJOdHduOWtNcTA" rel="nofollow">Пул коннектов</a>
    </h3>
    <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> <a href="https://www.youtube.com/watch?v=J9GzE2qlNuM&amp;feature=youtu.be&amp;t=2895" rel="nofollow">Александр Колесников - JDBC Pools Battle</a> (ссылка на выводы)</p>
    <blockquote>
        <p><a href="https://stackoverflow.com/a/1662916/548473" rel="nofollow">BoneCP to be deprecated </a></p>
    </blockquote>
    <ul>
        <li>Выбор реализации пула коннектов: <a href="https://commons.apache.org/proper/commons-dbcp/" rel="nofollow">Commons Database Connection Pooling</a>, <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a></li>
        <li><a href="https://habrahabr.ru/post/269023/" rel="nofollow">Самый быстрый пул соединений на java (читаем комменты)</a></li>
        <li><a href="http://blog.ippon.fr/2013/03/13/improving-the-performance-of-the-spring-petclinic-sample-application-part-3-of-5" rel="nofollow">Tomcat pool</a></li>
    </ul>
    <h3>
        <a id="user-content--7-spring-data-jpa" class="anchor" aria-hidden="true" href="#-7-spring-data-jpa">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 7. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFYVdyMFYxRUR6bWM" rel="nofollow">Spring Data JPA</a>
    </h3>
    <h4>
        <a id="user-content-apply-5_7_spring_data_jpapatch" class="anchor" aria-hidden="true" href="#apply-5_7_spring_data_jpapatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_7_spring_data_jpa.patch
    </h4>
    <blockquote>
        <ul>
            <li>Переименовал классы <em>Proxy</em> на более адекватные <em>Crud</em>, убрал <em>Impl</em></li>
            <li>В <code>spring-framework-bom</code> мы уже задали версию Spring. Убрал из остальных зависимостей.</li>
            <li>
                В spring-data-jpa 2.x поменялся интерфейс: <code>T CrudRepository.findOne(ID id)</code> -&gt; <code>Optional&lt;T&gt; CrudRepository findById(ID id)</code>
                <ul>
                    <li><a href="http://sboychenko.ru/java-optional" rel="nofollow">Java Optional — Отец холиваров</a></li>
                    <li><a href="https://www.mkyong.com/java8/java-8-optional-in-depth/" rel="nofollow">Java 8 Optional In Depth</a></li>
                </ul>
            </li>
            <li>Не стал переопределять в <code>CrudUserRepository</code> методы <code>JpaRepository</code> (для явного указания всех используемых методов). Обычно этого не делают.</li>
            <li>
                Т.к. используем свежий <code>spring-data-jpa</code>, поднял версию Spring до совместимой. Дополнительно:
                <ul>
                    <li><a href="https://spring.io/blog/2020/10/27/spring-framework-5-3-goes-ga" rel="nofollow">Spring Framework 5.3 goes GA</a></li>
                    <li><a href="https://spring.io/blog/2020/10/28/spring-data-2020-0-0-goes-ga" rel="nofollow">Spring Data 2020.0.0 goes GA</a></li>
                </ul>
            </li>
        </ul>
    </blockquote>
    <h3>
        <a id="user-content-внимание-при-обновлении-версий-не-забудьте-обновить-зависимости-maven-и-сделать-clean" class="anchor" aria-hidden="true" href="#внимание-при-обновлении-версий-не-забудьте-обновить-зависимости-maven-и-сделать-clean">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Внимание: при обновлении версий не забудьте обновить зависимости Maven и сделать <code>clean</code>.
    </h3>
    <ul>
        <li><a id="user-content-datajpa"></a><a href="http://projects.spring.io/spring-data-jpa/" rel="nofollow">Spring Data JPA</a></li>
        <li>Замена AbstractDAO: <a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.repositories" rel="nofollow">JPA Repositories</a></li>
        <li>Разрешение зависимостей: <a href="http://howtodoinjava.com/2014/02/18/maven-bom-bill-of-materials-dependency/" rel="nofollow">Maven BOM [Bill Of Materials] Dependency</a></li>
        <li><a href="https://habrahabr.ru/post/232381/#datajpa" rel="nofollow">Делегирование (в конце статьи)</a></li>
        <li><a href="https://spring.io/blog/2011/02/10/getting-started-with-spring-data-jpa" rel="nofollow">Getting started with Spring Data JPA</a></li>
        <li><a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation" rel="nofollow">Query methods</a></li>
        <li><a href="http://jeeconf.com/archive/jeeconf-2013/materials/spring-data/" rel="nofollow">Spring Data – новый взгляд на persistence (JeeConf)</a></li>
        <li><a href="https://www.youtube.com/watch?v=nwM7A4TwU3M" rel="nofollow">Евгений Борисов — Spring Data? Да, та!</a></li>
        <li>
            Ресурсы:
            <ul>
                <li><a href="https://github.com/spring-projects?query=spring-data">Github repositories</a></li>
                <li><a href="http://www.petrikainulainen.net/spring-data-jpa-tutorial" rel="nofollow">Spring Data JPA Tutorial</a></li>
                <li><a href="https://blog.42.nl/articles/spring-data-jpa-with-querydsl-repositories-made-easy/" rel="nofollow">Spring Data JPA with QueryDSL</a></li>
                <li><a href="https://spring.io/blog/2014/07/15/spel-support-in-spring-data-jpa-query-definitions" rel="nofollow">SpEL support in Spring Data JPA @Query</a></li>
            </ul>
        </li>
    </ul>
    <h2>
        <a id="user-content--ваши-вопросы" class="anchor" aria-hidden="true" href="#-ваши-вопросы">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="question" style="max-width:100%;"></a> Ваши вопросы
    </h2>
    <blockquote>
        <p>Какой паттерн проектирования применён в классе DataJpaUserRepository (декоратор/адаптер/прокси/другой)?:</p>
    </blockquote>
    <p>Вопрос интересный:) Ближе всего к адаптеру, но скорее композиция с делегированием. Мы просто используем для нашей реализации возможности <code>data-jpa: CrudUserRepository</code>.
        Делегат интерфейсов не меняет, а прокси похож на делегата, но служит для неявной подмены (часто прямо в рантайм). См. <a href="https://refactoring.guru/ru/design-patterns" rel="nofollow">ПАТТЕРНЫ
        ПРОЕКТИРОВАНИЯ</a>
    </p>
    <blockquote>
        <p>В <a href="https://github.com/spring-projects/spring-petclinic/tree/master/src/main/java/org/springframework/samples/petclinic">spring-petclinic</a> <code>DataJpa</code> реализована без дополнительных классов. В таком виде как у них, spring data смотрится, конечно, намного лаконичней других реализаций, но у нас получилось  вдвое больше кода, чем с тем же jpa или jdbc. Плюс только пожалуй в том, что query находятся прямо в репозитории, а  не где-то там в другом пакете. Так что получается, spring data лучше подходит для простейших crud без всяких "фишек"? или в чем его достоинство для больших и сложных проектов?</p>
    </blockquote>
    <p>Достоинства DATA-JPA по сравнению, например, с JPA: есть типизация, готовые реализации типовых методов CRUD, а также paging, data-common. Мы можем переключить реализацию JPA, например, на mongoDb (<code>PagingAndSortingRepository</code>, от которого наследуется <code>JpaRepository</code>, находится в <code>spring-data-common</code>).
        Соответственно, его методы будут поддерживаться всеми реализациями <code>spring-data-common</code> (JPA - одна из них) и пр. Подробнее о них есть в видео <a href="http://jeeconf.com/archive/jeeconf-2013/materials/spring-data/" rel="nofollow">Spring Data – новый взгляд на persistence</a>.
        Дополнительное проксирование в DATA-JPA - моя "фишка" для устранения минусов этого фреймворка: невозможность дебага, привязка к интерфейсу JpaRepository, перенос логики Repository в слой сервисов.
        Для большого приложения выигрыш этого стоит. Для небольших (тестовых) приложений (например выпускного) дополнительных классов лучше не делать.
    </p>
    <blockquote>
        <p>Почему мы для InMemory не сделали отдельного профиля? Почему их не удалить вообще?</p>
    </blockquote>
    <p>Реализация InMemory является примером, как в test делать подмену контекста. Для них сделали отдельный <code>inmemory.xml</code>, и запускаемый проект ничего не должен о них знать. У нас учебный проект, в котором 4 реализации репозиториев, в реальном такого не будет.</p>
    <blockquote>
        <p>А как делать транзакционность для реализации jdbc?</p>
    </blockquote>
    <p>Будем делать на следующем уроке.</p>
    <h3>
        <a id="user-content--8-spring-кэш" class="anchor" aria-hidden="true" href="#-8-spring-кэш">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 8. <a href="https://drive.google.com/file/d/1xpuL2YscL1ounS_qFRb1qzLciEOKn9I4/view?usp=sharing" rel="nofollow">Spring кэш</a>
    </h3>
    <h4>
        <a id="user-content-apply-5_8_spring_cachepatch" class="anchor" aria-hidden="true" href="#apply-5_8_spring_cachepatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 5_8_spring_cache.patch
    </h4>
    <ul>
        <li>
            <a href="https://ru.wikipedia.org/wiki/%D0%9A%D1%8D%D1%88" rel="nofollow">Wiki Кэш</a>
            <ul>
                <li><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache" rel="nofollow">Spring Cache Abstraction</a></li>
                <li><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache-store-configuration" rel="nofollow">Configuring the Cache Storage</a></li>
            </ul>
        </li>
        <li><a href="https://russianblogs.com/article/75981527090/" rel="nofollow">Spring 3.1 новый механизм кеширования</a></li>
        <li><a href="https://imhoratiu.wordpress.com/2017/01/26/spring-4-with-ehcache-3-how-to/" rel="nofollow">Spring 4+ with Ehcache 3 – how to</a></li>
        <li><a href="https://stackoverflow.com/questions/29557959/evict-ehcache-elements-programmatically-using-spring" rel="nofollow">Evict Ehcache elements programmatically, using Spring</a></li>
    </ul>
    <hr>
    <h2>
        <a id="user-content--домашнее-задание-hw05" class="anchor" aria-hidden="true" href="#-домашнее-задание-hw05">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png" alt="hw" style="max-width:100%;"></a> Домашнее задание HW05
    </h2>
    <ul>
        <li>1: Имплементировать <code>DataJpaMealRepository</code> и протестировать через <code>MealServiceTest</code>.</li>
    </ul>
    <h4>
        <a id="user-content-mealservlet-не-работает-почему-чиним-в-optional-п5" class="anchor" aria-hidden="true" href="#mealservlet-не-работает-почему-чиним-в-optional-п5">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        MealServlet не работает (почему?), чиним в <em>Optional п.5</em>
    </h4>
    <ul>
        <li>
            2: Разделить реализации Repository по профилям Spring: <code>jdbc</code>, <code>jpa</code>, <code>datajpa</code> (общее в профилях можно объединять, например, <code>&lt;beans profile="datajpa,jpa"&gt;</code>).
            <ul>
                <li>2.1: Профили выбора DB (<code>postgres/hsqldb</code>) и реализации репозитория (<code>jdbc/datajpa/jpa</code>) независимы друг от друга, и при запуске приложения (тестов) нужно задать тот, и другой.</li>
                <li>2.2: Для интеграции с IDEA не забудьте выставить в <code>spring-db.xml</code> справа вверху в <code>Change Profiles...</code> профили, например, <code>datajpa, postgres</code>.</li>
                <li>2.3: Общие части для всех в <code>spring-db.xml</code> можно оставить как есть без профилей вверху файла <strong>(до первого <code>&lt;beans profile=</code> !!!)</strong>.</li>
            </ul>
        </li>
        <li>
            3: Сделать тесты всех реализаций (<code>jdbc, jpa, datajpa</code>) через наследование (без дублирования).
            <ul>
                <li>3.1 <strong>сделать один базовый класс для <code>MealServiceTest</code> и <code>UserServiceTest</code></strong>.</li>
                <li>3.2 сводку по времени выполнения тестов также сделать для <code>user</code></li>
            </ul>
        </li>
        <li>4: Проверить запуск всех тестов: <code>mvn test</code> (в IDEA Maven Lifecycle - <code>test</code>, кнопку <code>skipTest</code> отжать).</li>
    </ul>
    <h4>
        <a id="user-content-jdbc-реализация-не-работает-с-hsqldb-чиним-в-optional-п6" class="anchor" aria-hidden="true" href="#jdbc-реализация-не-работает-с-hsqldb-чиним-в-optional-п6">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <code>Jdbc</code> реализация не работает с <code>hsqldb</code>. Чиним в <em>Optional п.6</em>
    </h4>
    <h3>
        <a id="user-content-optional" class="anchor" aria-hidden="true" href="#optional">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Optional
    </h3>
    <ul>
        <li>5: Починить <code>MealServlet</code> и использовать в <code>SpringMain</code> реализацию DB: добавить профили. Попробуйте поднять Spring контекст без использования <code>spring.profiles.active</code>.</li>
        <li>
            6: Разделить <code>JdbcMealRepository</code> для HSQLDB (она не умеет работать с Java8 Time API) и Postgres через <code>@Profile</code> (для Postgres оставить <code>LocalDateTime</code>).
            <ul>
                <li>Цель задания - потренироваться с <a href="https://refactoring.guru/ru/design-patterns/template-method" rel="nofollow">паттерном "шаблонный метод"</a> и профилями Spring.
                    Какие бины Spring попадут в контекст зависит от выставления активных профилей при запуске (<code>@ActiveProfiles</code> в тестах) и конфигурации, где задаются бины для каждого профиля.
                    Абстрактные классы не создаются и в контекст не попадают.
                </li>
                <li>После выполнения разделения на основе профилей, можно предложить решение проще.</li>
            </ul>
        </li>
        <li>
            7: Сделать и протестировать в сервисах методы (тесты и реализация - только для <code>DataJpa</code>):
            <ul>
                <li>7.1:  достать по <code>id</code> пользователя вместе с его едой</li>
                <li>7.2:  достать по <code>id</code> и <code>userId</code>  еду вместе с пользователем</li>
                <li>7.3:  обращения к DB сделать в одной транзакции (можно сделать разные варианты). <a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany" rel="nofollow">Java Persistence/OneToMany</a></li>
            </ul>
        </li>
    </ul>
    <hr>
    <h3>
        <a id="user-content--типичные-ошибки-и-подсказки-по-реализации" class="anchor" aria-hidden="true" href="#-типичные-ошибки-и-подсказки-по-реализации">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png" alt="error" style="max-width:100%;"></a> Типичные ошибки и подсказки по реализации
    </h3>
    <ul>
        <li>1: Для того, чтобы не запускались родительские классы тестов, нужно сделать их <code>abstract</code>.</li>
        <li>2: В реализациях <code>JdbcMealRepository</code> <strong>код не должен дублироваться</strong>. Если вы возвращаете тип <code>Object</code>, посмотрите в сторону <a href="http://www.quizful.net/post/java-generics-tutorial" rel="nofollow">дженериков</a>.</li>
        <li>3: В <code>MealServlet/SpringMain</code> в момент <code>setActiveProfiles</code> контекст спринга еще не должен быть инициализирован, иначе выставление профиля уже ни на что не повлияет.
            Уметь пользоваться гугл для разработчика, это умение №1. Если застряли- попробуйте например слова: <code>spring context set profile</code>
        </li>
        <li>4: Если у метода нет реализации, то стандартно бросается <code>UnsupportedOperationException</code>. Для уменьшения количества кода при реализации <em>Optional</em> (п. 7, только <code>DataJpa</code>) попробуйте сделать <code>default</code> метод в интерфейсе.</li>
        <li>5: В Data-Jpa метод для ссылки на entity (аналог <code>em.getReference</code>) - <code>T getOne(ID id)</code></li>
        <li>6: Проверьте, что в <code>DataJpaMealRepository</code> все обращения к DB выполняются в <strong>одной транзакции</strong>.</li>
        <li>7: Для 7.1 <code>достать по id пользователя вместе с его едой</code> я в <code>User</code> добавил <code>List&lt;Meal&gt; meals</code>. Учесть, что у юзера может отсутствовать еда. <a href="http://stackoverflow.com/questions/5903774/ordering-a-join-fetched-collection-in-jpa-using-jpql-hql" rel="nofollow">Ordering a join fetched collection in JPA using JPQL/HQL</a></li>
        <li>8: Проверьте, что все тесты запускаются из Maven (имена классов тестов удовлетворяют соглашению) и итоги тестов класса выводятся корректно (не копятся). По умолчанию <a href="http://maven.apache.org/surefire/maven-surefire-plugin/examples/inclusion-exclusion.html" rel="nofollow">maven-surefire-plugin</a> включает в тесты классы, заканчивающиеся на Test.</li>
        <li>9: Атрибуты <code>resolver</code> и <code>profiles</code> в одном <code>@ActiveProfiles</code> вместе не работают (см. <code>org.springframework.test.context.support.ActiveProfilesUtils#resolveActiveProfiles</code>).
            <code>@ActiveProfiles</code> принимает в качестве параметра строку <strong>либо</strong> массив строк. В тестах можно задавать несколько <code>@ActiveProfiles</code> в разных классах, они суммируются
        </li>
        <li>10: <code>&lt;beans profile=</code> в конфигурации контекста должны находиться <strong>после</strong> всех остальных объявлений.</li>
    </ul>
</article>
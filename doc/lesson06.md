<article class="markdown-body entry-content container-lg" itemprop="text">
    <h1>
        <a id="user-content-онлайн-проект-topjava" class="anchor" aria-hidden="true" href="#онлайн-проект-topjava">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Онлайн-проект <a href="https://github.com/JavaWebinar/topjava">Topjava</a>
    </h1>
    <h2>
        <a id="user-content-материалы-занятия" class="anchor" aria-hidden="true" href="#материалы-занятия">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a href="https://drive.google.com/drive/folders/1Urw8CidiVJDIXd9IwyadjBxPmpsL_MCr" rel="nofollow">Материалы занятия</a>
    </h2>
    <h3>
        <a id="user-content--правки-в-проекте" class="anchor" aria-hidden="true" href="#-правки-в-проекте">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png" alt="correction" style="max-width:100%;"></a> Правки в проекте
    </h3>
    <h4>
        <a id="user-content-apply-6_0_fixpatch" class="anchor" aria-hidden="true" href="#apply-6_0_fixpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_0_fix.patch
    </h4>
    <ul>
        <li>Перенес <code>Profiles</code> в код проекта, <code>ActiveDbProfileResolver</code> оставил в тестах</li>
        <li>Небольшие правки</li>
    </ul>
    <h2>
        <a id="user-content--разбор-домашнего-задания-hw5" class="anchor" aria-hidden="true" href="#-разбор-домашнего-задания-hw5">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png" alt="hw" style="max-width:100%;"></a> Разбор домашнего задания HW5
    </h2>
    <h3>
        <a id="user-content--1-hw5-spring-profiles-spring-data-jpa" class="anchor" aria-hidden="true" href="#-1-hw5-spring-profiles-spring-data-jpa">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 1. <a href="https://drive.google.com/file/d/1dlhXeQr0fi0XymEFyBG-TXv5hpPgXtlT" rel="nofollow">HW5: Spring Profiles. Spring Data JPA</a>
    </h3>
    <h4>
        <a id="user-content-apply-6_01_hw5_data_jpapatch" class="anchor" aria-hidden="true" href="#apply-6_01_hw5_data_jpapatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_01_HW5_data_jpa.patch
    </h4>
    <p>Транзакция начинается, когда встречается первая <code>@Transactional</code>. С default propagation <code>REQUIRED</code> остальные <code>@Transactional</code> просто участвуют в первой. Поэтому ставим аннотацию сверху <code>DataJpaMealRepository.save()</code>, чтобы все обращения к базе внутри метода были в одной транзакции. Аналогично, если из сервиса собирается несколько запросов к репозиториям, <code>@Transactional</code> ставится над методом сервиса.</p>
    <h4>
        <a id="user-content-apply-6_02_hw5_profile_testpatch" class="anchor" aria-hidden="true" href="#apply-6_02_hw5_profile_testpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_02_HW5_profile_test.patch
    </h4>
    <p><strong>Для IDEA в <code>spring-db.xml</code> не забудьте выставить Spring Profiles. Например <code>datajpa, postgres</code></strong></p>
    <blockquote>
        <ul>
            <li>Заменил <code>description.getMethodName()</code> на <code>getDisplayName()</code> в выводе результатов тестов. После <code>printResult()</code> буфер сбрасывается в 0, чтобы не накапливать изменения.</li>
        </ul>
    </blockquote>
    <h4>
        <a id="user-content-apply-6_03_extract_rulespatch" class="anchor" aria-hidden="true" href="#apply-6_03_extract_rulespatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_03_extract_rules.patch
    </h4>
    <blockquote>
        <p>Вынес измерение времени и сводку в отдельный класс <code>TimingRules</code></p>
    </blockquote>
    <p><a href="https://carlosbecker.com/posts/junit-rules/#external-resources" rel="nofollow">JUnit Rules External Resources</a></p>
    <h2>
        <a id="user-content--2-hw5-optional" class="anchor" aria-hidden="true" href="#-2-hw5-optional">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 2. <a href="https://drive.google.com/file/d/1S6gOOzLV9ndSbPiSuyEmqhEy3xZoUpXZ" rel="nofollow">HW5: Optional</a>
    </h2>
    <h4>
        <a id="user-content-apply-6_04_hw5_optional_fix_jdbc_profilespatch" class="anchor" aria-hidden="true" href="#apply-6_04_hw5_optional_fix_jdbc_profilespatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_04_HW5_optional_fix_jdbc_profiles.patch
    </h4>
    <ul>
        <li><a href="http://javarticles.com/2013/12/spring-profiles.html" rel="nofollow">Spring Profiles</a>. <a href="https://www.javacodegeeks.com/2013/10/spring-4-conditional.html" rel="nofollow">Spring 4 Conditional</a>.</li>
        <li>
            дополнительно:
            <ul>
                <li>зайдите в исходники <code>@Profile</code> и посмотрите (подебажьте) его  реализацию через <code>@Conditional(ProfileCondition.class)</code>.</li>
                <li><a href="http://stackoverflow.com/a/43645463/548473" rel="nofollow">реализация через Java Config и Profiles на уровне методов</a></li>
            </ul>
        </li>
    </ul>
    <h4>
        <a id="user-content-apply-6_05_update_hsqldbpatch" class="anchor" aria-hidden="true" href="#apply-6_05_update_hsqldbpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_05_update_hsqldb.patch
    </h4>
    <p>В реальном проекте часто проблему можно решить простым обновлением версии: <a href="http://hsqldb.org/" rel="nofollow">new HSQLDB version supports Java 8 time API</a></p>
    <h4>
        <a id="user-content-apply-6_06_hw5_optional_fetch_joinpatch" class="anchor" aria-hidden="true" href="#apply-6_06_hw5_optional_fetch_joinpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_06_HW5_optional_fetch_join.patch
    </h4>
    <blockquote>
        <ul>
            <li>Добавил проверки и тесты на <code>NotFound</code> для <code>MealService.getWithUser</code> и  <code>UserService.getWithMeals</code></li>
            <li>Убрал <code>CascadeType.REMOVE</code>, в уроке далее будет про Cascade.</li>
        </ul>
    </blockquote>
    <ul>
        <li><a href="http://stackoverflow.com/questions/11938253/jpa-joincolumn-vs-mappedby" rel="nofollow">JPA JoinColumn vs mappedBy</a></li>
        <li><a href="https://en.wikibooks.org/wiki/Java_Persistence/OneToMany#Unidirectional_OneToMany.2C_No_Inverse_ManyToOne.2C_No_Join_Table_.28JPA_2.x_ONLY.29" rel="nofollow">Unidirectional OneToMany</a></li>
    </ul>
    <h4>
        <a id="user-content-apply-6_07_hw5_graph_batch_sizepatch" class="anchor" aria-hidden="true" href="#apply-6_07_hw5_graph_batch_sizepatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_07_HW5_graph_batch_size.patch
    </h4>
    <ul>
        <li><strong><a href="http://stackoverflow.com/questions/97197/what-is-the-n1-selects-issue" rel="nofollow">N+1 selects issue</a></strong></li>
        <li>
            <a href="https://docs.oracle.com/javaee/7/tutorial/persistence-entitygraphs002.htm" rel="nofollow">Using Named Entity Graphs</a>
            <ul>
                <li><a href="https://sysout.ru/entity-graph-v-spring-data-jpa/" rel="nofollow">Entity Graph в Spring Data JPA</a></li>
                <li><a href="http://stackoverflow.com/questions/31978011/what-is-the-diffenece-between-fetch-and-load-for-entity-graph-of-jpa" rel="nofollow"><code>EntityGraphType.FETCH</code> vs <code>LOAD</code></a></li>
            </ul>
        </li>
        <li><a href="https://dou.ua/lenta/articles/jpa-fetch-types/" rel="nofollow">Стратегии загрузки коллекций в JPA</a></li>
        <li><a href="https://dou.ua/lenta/articles/hibernate-fetch-types/" rel="nofollow">Стратегии загрузки коллекций в Hibernate</a></li>
    </ul>
    <blockquote>
        <p>Когда мы достаем всех юзеров с ролями без <code>@BatchSize</code>, делается запрос юзеров (1), и на каждого юзера идет в базу запрос ролей (+N).
            C <code>@BatchSize(size = 200)</code> делается запрос на юзеров (1), и затем роли достаются пачками для 200 юзеров (+ N/200).
        </p>
    </blockquote>
    <h2>
        <a id="user-content-занятие-6" class="anchor" aria-hidden="true" href="#занятие-6">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Занятие 6:
    </h2>
    <h3>
        <a id="user-content-добавил-тесты-на-валидацию" class="anchor" aria-hidden="true" href="#добавил-тесты-на-валидацию">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Добавил тесты на валидацию
    </h3>
    <blockquote>
        <ul>
            <li>К сожалению, в JUnit <a href="https://github.com/junit-team/junit4/pull/778">нет <code>ExpectedException.expectRootCause</code></a>. <code>AbstractServiceTest.validateRootCause()</code> сделал через <a href="https://stackoverflow.com/a/2935935/548473" rel="nofollow">JUnit 4.13 assertThrows</a>.</li>
        </ul>
    </blockquote>
    <blockquote>
        <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="" style="max-width:100%;"></a> Откуда у нас берется <code>ConstraintViolationException</code> в тестах на валидацию? Для каких наших исключений он является рутом?</p>
    </blockquote>
    <p>Прежде всего - пользуйтесь дебагом! Исключение легко увидеть в методе <code>getRootCause()</code>. Если подебажить выполение Hibernate валидации, то можно найти, где обрабатываются аннотации валидации и место в <code>org.hibernate.cfg.beanvalidation.BeanValidationEventListener.validate()</code>, где бросается <code>ConstraintViolationException</code>.<br>
        Cамое простое - поставить брекпойнт в конструкторах <code>ConstraintViolationException</code> или в <code>ValidationException</code> и запустить тест <code>createWithException</code> в дебаге.
    </p>
    <h4>
        <a id="user-content-apply-6_08_add_test_validationpatch---обновился-1103-в-1726" class="anchor" aria-hidden="true" href="#apply-6_08_add_test_validationpatch---обновился-1103-в-1726">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply <a href="https://drive.google.com/file/d/1DuM1i2WehewEQn6Bi5jOC88FQR6tYqWU" rel="nofollow">6_08_add_test_validation.patch</a> - обновился 11.03 в 17.26
    </h4>
    <p><strong>Тесты валидации для Jdbc не работают, нужно будет починить в HW6 (в реализация Jdbc валидация отсутствует)</strong></p>
    <h3>
        <a id="user-content--3-кэш-hibernate" class="anchor" aria-hidden="true" href="#-3-кэш-hibernate">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 3. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFeTV0SUFfblk5NE0" rel="nofollow">Кэш Hibernate</a>
    </h3>
    <blockquote>
        <p>Кэш мигрировал на 3.x</p>
    </blockquote>
    <h4>
        <a id="user-content-apply-6_09_hibernate_cachepatch" class="anchor" aria-hidden="true" href="#apply-6_09_hibernate_cachepatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_09_hibernate_cache.patch
    </h4>
    <p><strong>Теперь уже все Jdbc тесты поломались. Требуется починить в HW6</strong></p>
    <ul>
        <li><a href="http://habrahabr.ru/post/135176/" rel="nofollow">Уровни кэширования Hibernate</a></li>
        <li><a href="http://habrahabr.ru/post/136375/" rel="nofollow">Hibernate Cache. Практика</a></li>
        <li><a href="http://www.tutorialspoint.com/hibernate/hibernate_caching.htm" rel="nofollow">Hibernate - Caching</a></li>
        <li>Починка тестов: <a href="http://stackoverflow.com/questions/1603846/hibernate-2nd-level-cache-invalidation-when-another-process-modifies-the-databas" rel="nofollow">инвалидация кэша Hibernate</a></li>
        <li><a href="http://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#caching" rel="nofollow">Hibernate User Guide: Caching</a></li>
        <li><a href="https://www.boraji.com/index.php/hibernate-5-jcache-ehcache-3-configuration-example" rel="nofollow">Hibernate 5, Ehcache 3.x</a></li>
        <li>
            Ресурсы:
            <ul>
                <li><strong><a href="https://www.youtube.com/watch?list=PLYj3Bx1JM6Y7BKivc3eZwRUhWwBmbIFXg&amp;v=V-ljsrVy6pE" rel="nofollow">Hibernate performance tuning (Mikalai Alimenkou /Igor Dmitriev)</a></strong></li>
                <li><a href="http://stackoverflow.com/questions/3663979/how-to-use-jpa2s-cacheable-instead-of-hibernates-cache" rel="nofollow">JPA2 @Cacheable vs Hibernate @Cache</a></li>
                <li><a href="http://vladmihalcea.com/2015/06/08/how-does-hibernate-query-cache-work/" rel="nofollow">How does Hibernate Query Cache work</a></li>
                <li><a href="https://www.javacodegeeks.com/2014/06/pitfalls-of-the-hibernate-second-level-query-caches.html" rel="nofollow">Pitfalls of the Hibernate Second-Level / Query Caches</a></li>
            </ul>
        </li>
    </ul>
    <h3>
        <a id="user-content--4-cascade-auto-generate-ddl" class="anchor" aria-hidden="true" href="#-4-cascade-auto-generate-ddl">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 4. <a href="https://drive.google.com/file/d/0B9Ye2auQ_NsFVmdpNDJSNXRTWUE" rel="nofollow">Cascade. Auto generate DDL.</a>
    </h3>
    <h4>
        <a id="user-content-apply-6_10_cascade_ddlpatch" class="anchor" aria-hidden="true" href="#apply-6_10_cascade_ddlpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_10_cascade_ddl.patch
    </h4>
    <h4>
        <a id="user-content-cascading" class="anchor" aria-hidden="true" href="#cascading">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Cascading
    </h4>
    <blockquote>
        <p>Есть SQL ON .. CASCADE, которая выполняется в базе данных, и есть аннотация в Hibernate, исполняемая в приложении</p>
    </blockquote>
    <ul>
        <li><a href="http://stackoverflow.com/questions/13027214" rel="nofollow">Do not use <code>CascadeType</code> for @ManyToOne</a></li>
        <li><a href="http://stackoverflow.com/questions/836569" rel="nofollow">CascadeType meaning</a></li>
        <li><a href="https://en.wikibooks.org/wiki/Java_Persistence/ElementCollection" rel="nofollow">No cascade option on an ElementCollection, the target objects are always persisted, merged, removed with their parent.</a></li>
        <li><a href="http://stackoverflow.com/questions/21149660" rel="nofollow">Create ON DELETE CASCADE: <code>@OnDelete</code></a></li>
        <li><a href="https://stackoverflow.com/a/62848296/548473" rel="nofollow">Сascade for <code>@ElementCollection</code></a></li>
        <li><a href="http://stackoverflow.com/questions/3087040" rel="nofollow">Hibernate second level cache and ON DELETE CASCADE in database schema</a></li>
        <li><a href="http://stackoverflow.com/a/19645397/548473" rel="nofollow"><code>orphanRemoval=true</code> vs <code>CascadeType.REMOVE</code></a></li>
        <li><a href="http://stackoverflow.com/questions/7825484/jpa-delete-where-does-not-delete-children-and-throws-an-exception" rel="nofollow">JPA <code>cascade/orphanRemoval</code> doesn't work with <code>NamedQuery</code></a></li>
    </ul>
    <h4>
        <a id="user-content-auto-schema-generation" class="anchor" aria-hidden="true" href="#auto-schema-generation">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Auto schema generation
    </h4>
    <ul>
        <li><a href="http://www.radcortez.com/jpa-database-schema-generation/" rel="nofollow">JPA DATABASE SCHEMA GENERATION</a></li>
        <li><a href="http://stackoverflow.com/questions/7793395" rel="nofollow">hbm2ddl.auto and autoincrement</a></li>
        <li><a href="http://stackoverflow.com/questions/2585641" rel="nofollow">Hibernate/JPA DB Schema Generation Best Practices</a></li>
    </ul>
    <h3>
        <a id="user-content--5--spring-web" class="anchor" aria-hidden="true" href="#-5--spring-web">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 5.  <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFVE1jWkRucm1UTjA" rel="nofollow">Spring Web</a>
    </h3>
    <h4>
        <a id="user-content-apply-6_11_spring_webpatch" class="anchor" aria-hidden="true" href="#apply-6_11_spring_webpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_11_spring_web.patch
    </h4>
    <blockquote>
        <ul>
            <li>Для сборки проекта в окне Maven отключите тесты (<code>Toggele 'Skip Tests' Mode</code>)</li>
            <li>В <code>web.xml</code> задаются профили запуска по умолчанию: <code>&lt;param-value&gt;postgres,datajpa&lt;/param-value&gt;</code>. <strong>Если запускаетесь под HSQLDB, надо поменять на <code>hsqldb,datajpa</code></strong>.</li>
        </ul>
    </blockquote>
    <ul>
        <li><a href="http://www.mkyong.com/servlet/what-is-listener-servletcontextlistener-example/" rel="nofollow">ServletContextListener</a>.</li>
        <li><a href="https://docs.oracle.com/javaee/6/tutorial/doc/bnafi.html" rel="nofollow">Servlet Lifecycle</a></li>
    </ul>
    <h3>
        <a id="user-content--6---jps-jstl-internationalization" class="anchor" aria-hidden="true" href="#-6---jps-jstl-internationalization">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 6.   <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFN3k0ZVk1MnF5TjQ" rel="nofollow">JPS, JSTL, internationalization</a>
    </h3>
    <h4>
        <a id="user-content-apply-6_12_jsp_jstl_i18npatch" class="anchor" aria-hidden="true" href="#apply-6_12_jsp_jstl_i18npatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_12_jsp_jstl_i18n.patch
    </h4>
    <blockquote>
        <ul>
            <li>Поменял <code>users/meals</code> в ключах локализации на <code>user/meal</code>. Понадобится при локализации ошибок (сделаем позже)</li>
            <li><a href="https://docs.oracle.com/javase/9/intl/internationalization-enhancements-jdk-9.htm" rel="nofollow">Since Java 9 default encoding in properties files is UTF-8</a>. Галочка <code>Transparent</code> и ASCII кода уже не нужны.</li>
        </ul>
    </blockquote>
    <p><strong>Убедитесь, что <a href="https://github.com/JavaOPs/topjava/wiki/IDEA#%D0%9F%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%B8%D1%82%D1%8C-%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D1%83-utf-8">в настройках IDEA</a> кодировка везде UTF-8</strong></p>
    <ul>
        <li><a href="http://docs.oracle.com/javaee/1.3/tutorial/doc/JSPIntro8.html" rel="nofollow">Including Content in a JSP Page</a></li>
    </ul>
    <h3>
        <a id="user-content--7---динамическое-изменение-профиля-при-запуске" class="anchor" aria-hidden="true" href="#-7---динамическое-изменение-профиля-при-запуске">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 7.   <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFLTB3R3pKNFNEQmM" rel="nofollow">Динамическое изменение профиля при запуске.</a>
    </h3>
    <pre><code>-Dspring.profiles.active="datajpa,postgres"
</code></pre>
    <ul>
        <li><a href="http://stackoverflow.com/questions/10041410/default-profile-in-spring-3-1#answer-10041835" rel="nofollow">Set profiles in Spring 3.1</a></li>
    </ul>
    <h3>
        <a id="user-content--8---конфигурирование-tomcat-через-maven-plugin-jndi-lookup" class="anchor" aria-hidden="true" href="#-8---конфигурирование-tomcat-через-maven-plugin-jndi-lookup">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 8.   <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFdkFRRFdYa0NoWkU" rel="nofollow">Конфигурирование Tomcat через maven plugin. Jndi-lookup.</a>
    </h3>
    <p>С плагином мы можем сконфигурировать Tomcat прямо в <code>pom.xml</code> и запустить его с задеплоенным туда нашим приложением WAR из командной строки
        без IDEA и без инсталляции Tomcat. По умолчанию он скачивает его из центрального maven-репозитория (можно также указать свой в <code>&lt;container&gt;&lt;home&gt;${container.home}&lt;/home&gt;&lt;/container&gt;</code>).
        При запуске Tomcat из IDEA запускается Tomcat, путь к которому мы прописали в конфигурации запуска (со своими настройками).
    </p>
    <h4>
        <a id="user-content-apply-6_13_tomcat_pool_jndi_cargopatch" class="anchor" aria-hidden="true" href="#apply-6_13_tomcat_pool_jndi_cargopatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_13_tomcat_pool_jndi_cargo.patch
    </h4>
    <blockquote>
        <ul>
            <li>для запуска в Tomcat 9 поменял <code>tomcat7-maven-plugin</code> на <code>cargo-maven3-plugin</code>.</li>
            <li>в <code>pom.xml</code> вместо <code>context.xml.default</code> можно делать <a href="https://stackoverflow.com/a/60797999/548473" rel="nofollow">индивидуальный контекст приложения</a></li>
            <li>плагин сконфигурирован под postgres. Для HSQLDB нужно скорректировать <code>driverClassName</code> + <code>validationQuery="SELECT 1 FROM INFORMATION_SCHEMA.SYSTEM_USERS</code> в <code>context.xml</code> и <code>dependencies</code>.</li>
        </ul>
    </blockquote>
    <blockquote>
        <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="" style="max-width:100%;"></a> Томкат сам управляет пулом коннектов? На каждый запрос в браузере будет даваться свой коннект?</p>
    </blockquote>
    <p>Да, в Томкате есть реализация пула коннектов <code>tomcat-jdbc</code> (мы его подключаем со <code>scope=provided</code>). Если запускаемся с профилем <code>tomcat</code>, приложение на каждую транзакцию (или операцию не в транзакции) берет коннект к базе из пула, сконфигурированного в подкладываемом Tomcat <code>context.xml</code>.</p>
    <blockquote>
        <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="" style="max-width:100%;"></a> Для чего мы делаем профиль <code>tomcat</code>? Возможно два варианта запуска приложения: либо cargo, либо tomcat? И если мы запускаем через tomcat то в <code>spring-db.xml</code> через <code>jee:jndi-lookup</code> подтягивается конфигурация tomcata из <code>\src\main\resources\tomcat\context.xml</code>?</p>
    </blockquote>
    <ol>
        <li>Есть <code>cargo-maven3-plugin</code> который автоматически запускает Tomcat и деплоит туда наше приложение. Те это тоже деплой в Tomcat, но через Maven.</li>
        <li>В xml конфигурации Tomcat можно настраивать ресурсы (кроме пула коннектов к БД могут быть, например, JMS или настройки Mail). Это никак не связано с <code>cargo</code> плагином. В Spring этот сконфигурированный ресурс контейнера сервлетов подлючается через <code>jee:jndi-lookup</code>. Тк у нас несколько вариантов конфигурирования <code>DataSource</code>, мы этот вариант сделали в <code>spring-db.xml</code> в профиле <code>tomcat</code>.</li>
        <li>Плагин cargo позволяет задавать xml конфигурацию запускаемого Tomcat (у нас <code>src/main/resources/tomcat/context.xml</code>). И в параметрах запуска мы задаем активные профили Spring <code>tomcat,datajpa</code> через <code>spring.profiles.active</code>. Таким образом мы в плагине конфигурируем Tomcat, деплоим в него приложение и задаем приложению активные профили Spring для <code>DataSource</code> из конфигурации Tomcat.</li>
    </ol>
    <p>Плагин запускается <strong>после сборки проекта</strong>. Запуск из командной строки:</p>
    <pre><code> mvn clean package -DskipTests=true org.codehaus.cargo:cargo-maven3-plugin:1.9.2:run
</code></pre>
    <p>Приложение деплоится в application context topjava: <a href="http://localhost:8080/topjava" rel="nofollow">http://localhost:8080/topjava</a></p>
    <ul>
        <li><a href="https://codehaus-cargo.github.io/cargo/Maven+3+Plugin.html" rel="nofollow">Cargo Maven3 plugin</a></li>
        <li><a href="http://stackoverflow.com/questions/4305935/is-it-possible-to-supply-tomcat6s-context-xml-file-via-the-maven-cargo-plugin#4417945" rel="nofollow">Кастомизация context.xml в cargo-maven2-plugin</a></li>
        <li><a href="https://tomcat.apache.org/tomcat-8.0-doc/jndi-resources-howto.html" rel="nofollow">Tomcat JNDI Resources</a></li>
        <li><a href="https://commons.apache.org/proper/commons-dbcp/configuration.html" rel="nofollow">BasicDataSource Configuration</a></li>
    </ul>
    <h3>
        <a id="user-content--9-spring-web-mvc" class="anchor" aria-hidden="true" href="#-9-spring-web-mvc">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 9. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFQThUX2VyQXNiTHM" rel="nofollow">Spring Web MVC</a>
    </h3>
    <h4>
        <a id="user-content-apply-6_14_spring_webmvcpatch" class="anchor" aria-hidden="true" href="#apply-6_14_spring_webmvcpatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_14_spring_webmvc.patch
    </h4>
    <p>Обработка запросов переезжает в <code>RootController</code>, сервлеты уже не нужны</p>
    <blockquote>
        <ul>
            <li>Починил <a href="http://stackoverflow.com/questions/10327390/how-should-i-get-root-folder-path-in-jsp-page" rel="nofollow">путь к корню</a></li>
            <li>В Spring 4.3 ввели новые аннотации <code>@Get/Post/...Mapping</code> (сокращенный вариант <code>@RequestMapping</code>)</li>
        </ul>
    </blockquote>
    <ul>
        <li><a id="user-content-mvc"></a><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc" rel="nofollow">Spring Web MVC</a></li>
        <li><a href="https://howtodoinjava.com/spring-mvc/contextloaderlistener-vs-dispatcherservlet/" rel="nofollow">ContextLoaderListener vs DispatcherServlet</a></li>
        <li><a href="http://design-pattern.ru/patterns/front-controller.html" rel="nofollow">Паттерн Front Controller</a></li>
        <li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-servlet-context-hierarchy" rel="nofollow">Иерархия контекстов в Spring Web MVC</a></li>
        <li><a href="http://www.tutorialspoint.com/spring/spring_web_mvc_framework.htm" rel="nofollow">Сценарий обработки запроса</a>. <a href="http://www.studytrails.com/frameworks/spring/spring-mvc.jsp" rel="nofollow">HandlerMappings</a></li>
        <li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-viewresolver" rel="nofollow">View Resolution</a>: прячем jsp под WEB-INF.</li>
        <li>HandlerMapping: <a href="http://www.mkyong.com/spring-mvc/spring-mvc-simpleurlhandlermapping-example/" rel="nofollow">SimpleUrlHandlerMapping</a>, <a href="http://www.mkyong.com/spring-mvc/spring-mvc-beannameurlhandlermapping-example/" rel="nofollow">BeanNameUrlHandlerMapping</a></li>
        <li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-caching-static-resources" rel="nofollow">Маппинг ресурсов.</a></li>
        <li>Ресурсы:</li>
        <li><a href="http://www.mkyong.com/spring-mvc/spring-mvc-hello-world-example/" rel="nofollow">Spring MVC hello world</a></li>
        <li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-servlet-special-bean-types" rel="nofollow">Special bean types in the WebApplicationContext</a></li>
    </ul>
    <blockquote>
        <p>Настройки <code>Project Structure-&gt;Modules-&gt;Spring</code>:</p>
    </blockquote>
    <p><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/11200258/111077810-953b0000-8503-11eb-8d4d-03320fce2cf3.png"><img src="https://user-images.githubusercontent.com/11200258/111077810-953b0000-8503-11eb-8d4d-03320fce2cf3.png" alt="image" style="max-width:100%;"></a></p>
    <blockquote>
        <p><a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="" style="max-width:100%;"></a> В <code>web.xml</code> мы инициализируем <code>DispatcherServlet</code>, передавая ему параметром <code>spring-mvc.xml</code>. Получается, что <code>DispatcherServlet</code> парсит <code>spring-mvc.xml</code> и находит в нем context?</p>
    </blockquote>
    <p>Да, можно подебажить родителя (<code>FrameworkServlet.initWebApplicationContext()</code>). После инициализации сервлет <code>DispatcherServlet</code> раскидывает все запросы по контроллерам (бинам контекста Спринга). См. <a href="http://design-pattern.ru/patterns/front-controller.html" rel="nofollow">паттерн Front Controller</a>.</p>
    <h3>
        <a id="user-content--10-spring-internationalization" class="anchor" aria-hidden="true" href="#-10-spring-internationalization">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672715/06dbc6ce-e6e7-11e5-81a9-04fbddb9e488.png" alt="video" style="max-width:100%;"></a> 10. <a href="https://drive.google.com/open?id=0B9Ye2auQ_NsFUEctTkRSMWNvRjg" rel="nofollow">Spring Internationalization</a>
    </h3>
    <h4>
        <a id="user-content-apply-6_15_spring_i18npatch" class="anchor" aria-hidden="true" href="#apply-6_15_spring_i18npatch">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Apply 6_15_spring_i18n.patch
    </h4>
    <p><strong>Внимание: проверьте, что переменная окружения <code>TOPJAVA_ROOT</code> настроена!</strong></p>
    <blockquote>
        <ul>
            <li>В локализации поменял <a href="https://stackoverflow.com/questions/4441682/what-to-use-for-localization-in-jsps-with-spring" rel="nofollow"><code>fmt:message</code> на <code>spring:message</code></a></li>
            <li>Выбор языка зависит от языка операционной системы и заголовка <code>Accept-Language</code>. Добавил в <code>spring-mvc.xml</code> <code>messageSource</code> параметр <a href="http://stackoverflow.com/questions/4281504/spring-local-sensitive-data" rel="nofollow"><code>fallbackToSystemLocale</code></a>.
                Он управляет выбором, куда переключаться при выборе <code>en</code> и отсутствии <code>app_en.properties</code>: локаль операционной системы или <code>app.properties</code> (<code>fallbackToSystemLocale=false</code>). Переключение локалей будем реализовывать в конце проекта.
            </li>
        </ul>
    </blockquote>
    <h4>
        <a id="user-content-для-тестирования-локали-можно-поменять-accept-language-для-хрома-в-chromesettingslanguages-перетащить-нужную-локаль-наверх-или-поставить-плагин-locale-switcher" class="anchor" aria-hidden="true" href="#для-тестирования-локали-можно-поменять-accept-language-для-хрома-в-chromesettingslanguages-перетащить-нужную-локаль-наверх-или-поставить-плагин-locale-switcher">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Для тестирования локали <a href="https://stackoverflow.com/questions/7769061/how-to-add-custom-accept-languages-to-chrome-for-pseudolocalization-testing" rel="nofollow">можно поменять <code>Accept-Language</code></a>. Для Хрома в <code>chrome://settings/languages</code> перетащить нужную локаль наверх или поставить <a href="https://chrome.google.com/webstore/detail/locale-switcher/kngfjpghaokedippaapkfihdlmmlafcc" rel="nofollow">плагин Locale Switcher</a>
    </h4>
    <ul>
        <li><a href="http://learningviacode.blogspot.ru/2012/07/reloadable-messagesources.html" rel="nofollow">Reloadable MessageSources</a></li>
        <li><a href="http://nginx.com/resources/admin-guide/serving-static-content/" rel="nofollow">nginx: Serving Static Content</a></li>
    </ul>
    <h2>
        <a id="user-content--ваши-вопросы" class="anchor" aria-hidden="true" href="#-ваши-вопросы">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672858/9cd58692-e6e7-11e5-905d-c295d2a456f1.png" alt="question" style="max-width:100%;"></a> Ваши вопросы
    </h2>
    <blockquote>
        <p>Кэш hibernate надстраивается над ehcache или живет самостоятельно?</p>
    </blockquote>
    <ul>
        <li><a href="http://mrbool.com/understanding-hibernate-caching/28721" rel="nofollow">Understanding Hibernate Caching</a>:
            Hibernate supports following open-source cache implementations out-of-the-box: EHCache (Easy Hibernate Cache), OSCache (Open Symphony Cache), Swarm Cache, and JBoss Tree Cache.
        </li>
    </ul>
    <blockquote>
        <p>Где конфигурируется интернализация для jstl (т.е. файл, где задаются app, app_ru.properties)? Достаточно указать в страницах bundle и путь в ресурсы?</p>
    </blockquote>
    <p><code>&lt;fmt:setBundle basename="messages.app"/&gt;</code> означает, что ресурсы будут искаться в <code>classpath:messages/app(_xx)/properties</code>:
        <a href="http://docs.oracle.com/javaee/5/jstl/1.1/docs/tlddocs/fmt/setBundle.html" rel="nofollow">Tag setBundle</a>: fully-qualified resource name, which has the same form as a fully-qualified class name.
        После сборки проекта maven их можно найти в <code>target/classes</code> или <code>target/topjava/WEB-INF/classes</code>.
    </p>
    <blockquote>
        <p>Отлично, что она все пишет на том языке, который пришел в заголовке запроса. А если я хочу выбрать?</p>
    </blockquote>
    <p>Выбор языка зависит от языка операционной системы и заголовка <code>Accept-Language</code>. Параметр <code>fallbackToSystemLocale</code>, который управляет выбором, когда с <code>Accept-Language: en,en-US;</code> не находится локализация <code>app_en.properties</code>. Для переключения локали используется <a href="http://www.codejava.net/java-ee/jstl/jstl-format-tag-setlocale" rel="nofollow">JSTL Format Tag fmt:setLocale</a>. Мы будем реализовывать переключение локалей в Spring i18n в конце проекта.</p>
    <blockquote>
        <p>Мы создаем бин, где получаем dataSource по имени <code>&lt;jee:jndi-lookup id="dataSource" jndi-name="java:comp/env/jdbc/topjava"/&gt;</code>.
            Но там не указан класс, как в других dataSource. Получается, по имени jdbc/topjava нам уже отдается готовый объект dataSource, и мы как бы помещаем его в бин?
        </p>
    </blockquote>
    <p>Здесь используется namespace <code>jee:jndi-lookup</code>, который прячет под собой классы реализации. JNDI объект DataSource конфигурируется в <code>src/main/resources/tomcat/context.xml</code></p>
    <blockquote>
        <p>В плагине прописан профиль <code>&lt;spring.profiles.active&gt;tomcat,datajpa&lt;/spring.profiles.active&gt;</code>, а в web.xml <code>&lt;param-value&gt;postgres,datajpa&lt;/param-value&gt;</code>.
            Какой же реально отрабатывает?
        </p>
    </blockquote>
    <p>См. видео урока "Динамическое изменение профиля при запуске". В плагине мы задаем параметры JVM запуска Tomcat</p>
    <blockquote>
        <p>Почему мы не используем элемент <code>&lt;context:annotation-config/&gt;</code> в <code>spring-db.xml</code>?</p>
    </blockquote>
    <p>В проекте у нас сейчас 2 Spring контекста: <code>spring-mvc.xml (см. web.xml, DispatcherServlet)</code> и родительский <code>spring-app.xml + spring-db.xml (web.xml, contextConfigLocation)</code>.
        Грубо: 2 мапы, причем для mvc доступно все, что есть в родителе. Т.е. <code>spring-db.xml</code> не является отдельным самостоятельным контекстом, и достаточно того, что <code>&lt;context:annotation-config/&gt;</code> у нас есть в <code>spring-app.xml</code>.
    </p>
    <blockquote>
        <p>A <code>@NamedQuery</code> или <code>@Query</code> подвержены кэшу запросов? Т.е. если мы поставим <em>USE_QUERY_CACHE_value</em>="true", будет ли Hibernate их кэшировать?</p>
    </blockquote>
    <p>Чтобы запрос кэшировался, кроме true в конфигурации <a href="http://vladmihalcea.com/2015/06/08/how-does-hibernate-query-cache-work/" rel="nofollow">нужно еще явно выставить запросу <em>setCacheable</em></a>.<br>
        По поводу кэширования <code>@NamedQuery</code> нашел <a href="https://docs.jboss.org/jbossas/docs/Clustering_Guide/5/html/ch04s02s03.html" rel="nofollow"><code>@QueryHint</code></a>
    </p>
    <blockquote>
        <p>Почему messages мы кладем в config и используем system environment? Разве так делают в реальном проекте? Не будешь же вписывать на сервере эти переменные каждый раз, если проект куда-то будет переезжать. Можно по-другому, кроме systemEnvironment['TOPJAVA_ROOT'], задать путь от корня проекта?</p>
    </blockquote>
    <ol>
        <li>messages нам нужны в runtime (при работе приложения). Проект к собранному и задеплоенному в Tomcat war отношения никакого уже не имеет и на этом сервере он обычно не находится. Если ресурсы нужны только при сборке и тестировании, то путь к корню для одномодульного maven проекта можно задать как <code>${project.basedir}</code>, но для многомодульного проекта (а все реальные проекты многомодульные) это путь к корню своего модуля.</li>
        <li>В "реальном приложении" делается совершенно по-разному:</li>
    </ol>
    <ul>
        <li>нести с собой в classpath, но ресурсы нельзя будет динамически (без передеплоя) обновлять</li>
        <li>класть в war (не в classpath) и обновлять в развернутом TOMCAT_HOME/webapps/[appname]/...</li>
        <li>класть в зафиксированное определенное место (например, в home: <code>~</code> или в путь от корня <code>/app/config</code>). Можно задавать фиксированный пусть в пропертях профиля maven и фильтровать ресурсы (maven resources), чтобы они попали в проперти проекта.</li>
        <li>делать через переменную окружения, как у нас</li>
        <li>задавать в параметрах запуска JVM как системную переменную через -D..</li>
        <li>располагать в преференсах (для unix это home, для windows - registry): <a href="http://java-course.ru/articles/preferences-api/" rel="nofollow">использование Preferences API</a></li>
        <li>держать настройки в DB</li>
    </ul>
    <p>Часто в одном приложении используют несколько способов для разных видов конфигураций.</p>
    <blockquote>
        <p>Не происходит ли дублирования при кэшировании пользователей чрез Hibernate и <code>@Cacheable</code>?</p>
    </blockquote>
    <p><code>@Cacheable</code> кэширует результат запроса <code>getAll()</code>, т.е. список юзеров. Hibernate кэширует юзеров по отдельности, т.е., грубо говоря, делает мапу id-&gt;User. Можно назвать это дублированием. Нужно ли будет такое в реальном приложении? Все смотрится из логики запросов и их частоты, вполне вероятно, что нет. Как-то мы писали приложение для Дойчебанка (аналог skype на GWT, т.е. на экране небольшое окошко) - там было 5(!!!) уровней кэширования, первый вообще в базе.</p>
    <blockquote>
        <p>У меня стоит Томкат 8-й версии, в помнике у нас 9-й прописан, но всё работает. Почему?</p>
    </blockquote>
    <p>В <code>pom.xml</code> мы подключаем <code>tomcat-servlet-api</code> со <code>scope=provided</code>, что означает, что он используется только для компиляции и не идет в war. Т.к. мы не используем никаких фич Tomcat 9.x, то наш код совместим с Tomcat 8.x. При запуске через <code>cargo-maven2-plugin</code> Tomcat 9 загружается из maven-репозитория.</p>
    <blockquote>
        <p>Откуда <code>@Transactional</code> вытягивает класс для работы с транзакцией, в составе какого бина он идет?</p>
    </blockquote>
    <ol>
        <li>Если в контексте Spring есть <code>&lt;tx:annotation-driven/&gt;</code>, то подключается <code>BeanPostProcessors</code>, который проксирует классы (и методы), помеченные <code>@Transactional</code>.</li>
        <li>По умолчанию для TransactionManager используется бин с <code>id=transactionManager</code></li>
    </ol>
    <hr>
    <h2>
        <a id="user-content--домашнее-задание-hw06" class="anchor" aria-hidden="true" href="#-домашнее-задание-hw06">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672719/09593080-e6e7-11e5-81d1-5cb629c438ca.png" alt="hw" style="max-width:100%;"></a> Домашнее задание HW06
    </h2>
    <ul>
        <li>1.1 Починить тесты <code>InMemoryAdminRestControllerSpringTest/InMemoryAdminRestControllerTest</code>  (добавлять <code>spring-mvc.xml</code> в контекст не стоит, т.к. в новой версии Spring для этого требуется <code>WebApplicationContext</code>. Можно просто поправить <code>inmemory.xml</code>)</li>
        <li>
            1.2 Починить тесты Jdbc (исключить валидацию в тестах Jdbc)
            <ul>
                <li><a href="http://iliachemodanov.ru/ru/blog-ru/12-tools/57-junit-ignore-test-by-condition-ru" rel="nofollow">org.junit.Assume</a></li>
                <li><a href="https://ekiras.blogspot.com/2015/09/spring-how-to-get-current-profiles-in-spring-application.html" rel="nofollow">How to get Current Profiles in Spring Application</a></li>
            </ul>
        </li>
        <li>
            1.3 Перенести функциональность <code>MealServlet</code> в <code>JspMealController</code> контроллер (по аналогии с <code>RootController</code>).
            <code>MealRestController</code> у нас останется, с ним будем работать позже.
            <ul>
                <li>1.3.1 разнести запросы на update/delete/.. по разным методам (попробуйте вообще без параметра <code>action=</code>). Можно по аналогии с <code>RootController#setUser</code> принимать <code>HttpServletRequest request</code> (аннотации на параметры и адаптеры для <code>LocalDate/Time</code> мы введем позже).</li>
                <li>1.3.2 в одном контроллере нельзя использовать другой. Чтобы не дублировать код, можно сделать наследование контроллеров от абстрактного класса.</li>
                <li>1.3.3 добавить локализацию и <code>jsp:include</code> в <code>mealForm.jsp / meals.jsp</code></li>
            </ul>
        </li>
    </ul>
    <h3>
        <a id="user-content-optional" class="anchor" aria-hidden="true" href="#optional">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Optional
    </h3>
    <ul>
        <li>2.1 Добавить транзакционность (<code>DataSourceTransactionManager</code>) в Jdbc-реализации</li>
        <li>2.2 Добавить еще одну роль к юзеру Admin (будет 2 роли: <code>USER, ADMIN</code>).</li>
        <li>
            2.3 В <code>JdbcUserRepository</code> добавить реализацию ролей юзера (добавлять можно одним запросом с JOIN и <code>RowMapper</code>, либо двумя запросами (отдельно <code>users</code> и отдельно <code>roles</code>). <a href="http://www.skillz.ru/dev/php/article-Obyasnenie_SQL_obedinenii_JOIN_INNER_OUTER.html" rel="nofollow">Объяснение SQL JOIN</a>
            <ul>
                <li>2.3.1 В реализации <code>getAll</code> НЕ делать запрос ролей для каждого юзера (N+1 select)</li>
                <li>2.3.2 При save посмотрите на <a href="https://www.mkyong.com/spring/spring-jdbctemplate-batchupdate-example/" rel="nofollow">batchUpdate()</a></li>
            </ul>
        </li>
        <li>2.4 Добавить проверку ролей в <code>UserTestData.USER_MATCHER.assertMatch</code> и починить ВСЕ тесты (тесты должны проходить для юзера с несколькими ролями)</li>
        <li>
            2.5 Добавить валидацию для <code>Jdbc..Repository</code> через Bean Validation API (для JPA это делается автоматически при сохранении в базу, для Jdbc мы должны это делать вручную).  Оптимизировать код.
            <ul>
                <li>Валидацию <code>@NotNull</code> для <code>Meal.user</code> пока можно закомментировать. На 10-м уроке решим проблему через <a href="http://www.baeldung.com/jackson-json-view-annotation" rel="nofollow">Jackson JSON Views</a></li>
                <li><a href="https://alexkosarev.name/2018/07/30/bean-validation-api/" rel="nofollow">Валидация данных при помощи Bean Validation API</a></li>
            </ul>
        </li>
    </ul>
    <h3>
        <a id="user-content-optional-2-повышенной-сложности" class="anchor" aria-hidden="true" href="#optional-2-повышенной-сложности">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        Optional 2 (повышенной сложности)
    </h3>
    <ul>
        <li>
            3 Отключить кэш в тестах через <code>NoOpCacheManager</code> и для кэша Hibernate 2-го уровня <code>hibernate.cache.use_second_level_cache=false</code>.
            <ul>
                <li><a href="https://stackoverflow.com/a/58963737/548473" rel="nofollow">JPA 2.0 disable session cache for unit tests</a></li>
                <li><a href="https://www.concretepage.com/spring/example_propertyoverrideconfigurer_spring" rel="nofollow">Example of PropertyOverrideConfigurer</a></li>
                <li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#xsd-schemas-util" rel="nofollow">Spring util schema</a></li>
            </ul>
        </li>
    </ul>
    <hr>
    <h2>
        <a id="user-content--подсказки-по-hw06" class="anchor" aria-hidden="true" href="#-подсказки-по-hw06">
            <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
            </svg>
        </a>
        <a target="_blank" rel="noopener noreferrer" href="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png"><img src="https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png" alt="error" style="max-width:100%;"></a> Подсказки по HW06
    </h2>
    <ul>
        <li>1: Неверная кодировка UTF-8 с Spring обычно решается фильтром <code>CharacterEncodingFilter</code>:</li>
    </ul>
    <pre><code>    &lt;filter&gt;
        &lt;filter-name&gt;encodingFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;encoding&lt;/param-name&gt;
            &lt;param-value&gt;UTF-8&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;forceEncoding&lt;/param-name&gt;
            &lt;param-value&gt;true&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;encodingFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
</code></pre>
    <ul>
        <li>2: <strong>Если не поднимается контекст Spring, смотрим причину вверху самого нижнего исключения.</strong> Все ошибки на отсутствия бина в контексте или его нескольких реализациях относятся к пониманию основ: Spring application context. Если нет понимания этих основ, двигаться дальше нельзя, нужно вернуться к видео Спринг, где объясняется, что это такое. Также пересмотрите видео <a href="https://drive.google.com/file/d/1SPMkWMYPvpk9i0TA7ioa-9Sn1EGBtClD" rel="nofollow">Тестирование UserService через AssertJ</a>. Начиная с 11.30 как раз разбираются подобные ошибки.</li>
        <li>
            3: Если неправильно формируется url относительно контекста приложения (например, <code>/topjava/meals/meals</code>), посмотрите на
            <ul>
                <li><a href="http://stackoverflow.com/questions/4764405/how-to-use-relative-paths-without-including-the-context-root-name" rel="nofollow">Relative paths in JSP</a></li>
                <li><a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-redirecting-redirect-prefix" rel="nofollow">Spring redirect: prefix</a></li>
            </ul>
        </li>
        <li>4: При проблемах с запуском Томкат проверьте запущенные процессы <code>java</code>, нет ли в <code>TOMCAT_HOME\webapps</code> приложения каталога <code>topjava</code>, логи tomcat (нет ли проблем с доступом к каталогам или контекстом Spring)</li>
        <li>5: Если создаете неизменяемые List или Map, пользуйтесь <code>List.of()/ Map.of()</code></li>
        <li>6: В MealController общую часть <code>@RequestMapping(value = "/meals")</code> лучше вынести на уровень класса</li>
        <li>7: Проверьте <code>@Transactional(readOnly = true)</code> сверху <code>Jdbc..Repository</code></li>
        <li>8: Проверьте, что <code>config\messages\app_ru.properties</code> у вас в кодировке UTF-8 (в любом редакторе/вьюере или при отключенном <a href="https://github.com/JavaOPs/topjava/wiki/IDEA#%D0%9F%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%B8%D1%82%D1%8C-%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D1%83-utf-8">Transparent native-to-ascii conversion</a> в IDEA).</li>
        <li>9: Учтите, что роли у юзеров можно менять/добавлять/удалять</li>
        <li>10: Убедитесь, что все методы UserService корректно работают с юзерами, у которых несколько ролей (<strong>запусти наши тесты для Admin с 2-мя ролями</strong>)</li>
    </ul>
</article>